<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>√áiftlik üåæ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#388e3c" />

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e8f5e9;
    margin: 0; padding: 20px;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
  }
  #leftPanel {
    flex: none;
    width: 100%;
    max-width: 450px;
    text-align: center;
  }
  #info { font-size: 18px; margin-bottom: 8px; }
  /* YENƒ∞Lƒ∞K: XP √áubuƒüu i√ßin stiller */
  #xpBarContainer {
    width: 100%;
    background-color: #a5d6a7;
    border-radius: 10px;
    margin-bottom: 12px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
  }
  #xpBar {
    width: 0%;
    height: 18px;
    background-color: #4caf50;
    border-radius: 10px;
    text-align: center;
    line-height: 18px;
    color: white;
    font-size: 12px;
    font-weight: bold;
    transition: width 0.5s ease-in-out;
  }
  #inventory {
    display: flex; justify-content: center;
    margin-bottom: 15px; gap: 10px;
    flex-wrap: wrap;
  }
  .inv-item {
    cursor: pointer; font-size: 28px; padding: 5px 10px;
    border-radius: 8px; background-color: #81c784;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    user-select: none; border: 3px solid transparent;
    transition: border-color 0.3s;
    display: flex; align-items: center; gap: 6px;
    color: white; font-weight: bold;
  }
  .inv-item.selected { border-color: #33691e; }
  .inv-count { font-size: 18px; user-select: none; color: #1b5e20; }
  #farm {
    display: grid;
    grid-template-columns: repeat(5, 80px);
    grid-gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
    min-height: 400px;
  }
  .plot {
    width: 80px; height: 80px; background: #7b4f24;
    border-radius: 8px; cursor: pointer;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-weight: bold; color: white;
    box-shadow: 0 0 4px #000000aa;
    transition: background 0.3s; font-size: 30px;
    user-select: none;
    position: relative;
    flex-shrink: 0;
  }
  .plot.planted { background: #3e7d0a; }
  .plot.grown {
    background: #4caf50; color: #003300; font-size: 40px;
  }
  button {
    padding: 10px 20px; font-size: 16px; border-radius: 6px;
    border: none; background-color: #388e3c; color: white;
    cursor: pointer; transition: background-color 0.3s;
    margin: 5px; user-select: none;
  }
  button:hover:enabled { background-color: #2e7d32; }
  button:disabled {
    background-color: #a5d6a7; cursor: not-allowed;
  }
  #controls { margin-bottom: 15px; }
  #message {
    height: 24px; font-weight: bold; color: #2e7d32;
    margin-bottom: 12px; min-height: 24px;
  }
  #marketModal, #marketOverlay, #marketPricesModal, #storeModal {
    user-select: none;
  }
  #marketOverlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3); z-index: 900;
  }
  #marketModal, #marketPricesModal, #storeModal {
    display: none; position: fixed; top: 50%; left: 50%;
    width: 380px; background: white; border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    transform: translate(-50%, -50%);
    padding: 20px; z-index: 1000; max-height: 80vh;
    overflow-y: auto;
  }
  #marketModal h2, #marketModal h3, #marketPricesModal h2, #storeModal h2 {
    margin-top: 0; margin-bottom: 10px;
  }
  #marketModal .seedBtn, #marketModal .bugBtn, #marketModal .enhancerBtn, #marketModal .animalBtn, #marketModal .consumableBtn, #storeModal button, #storeModal #rentStoreBtn {
    display: flex; align-items: center; justify-content: space-between;
    background: #81c784; color: #004d00;
    margin: 6px 0; padding: 8px 12px; border-radius: 6px;
    cursor: pointer; font-weight: bold; font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.3s;
  }
  #marketModal .seedBtn:disabled, #marketModal .bugBtn:disabled, #marketModal .enhancerBtn:disabled, #marketModal .animalBtn:disabled, #marketModal .consumableBtn:disabled, #storeModal button:disabled, #storeModal #rentStoreBtn:disabled {
    background: #c8e6c9; color: #888; cursor: not-allowed;
    box-shadow: none;
  }
  #pagination {
    margin-bottom: 20px;
  }
  #pagination button {
    width: 40px; font-weight: bold; font-size: 18px; padding: 6px 0;
  }
  #bugFarm {
    width: 400px; height: 400px; background-color: #2196f3;
    border-radius: 12px; margin: 0 auto 20px;
    position: relative;
    cursor: default;
    overflow: hidden;
  }
  #animalFarm {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
    margin-bottom: 20px;
  }
  .animal {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    user-select: none;
    background: #81c784;
    border-radius: 10px;
    padding: 12px 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 320px;
    color: #004d00;
    font-weight: bold;
    font-size: 24px;
    position: relative;
  }
  .animal-emoji {
    font-size: 48px;
  }
  .animal-count {
    font-size: 18px;
    margin-top: 6px;
  }
  .harvest-status {
    font-weight: bold;
    color: #aed581;
    font-size: 14px;
    margin-top: 4px;
    user-select: none;
  }
  #storePage {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
  }
  #storeRentBtn {
    margin-bottom: 15px;
  }
  #storeMarketItems button {
    width: 100%;
  }
  #customers {
    margin-top: 20px;
  }
  .customer {
    background-color: #81c784;
    color: #004d00;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    margin: 6px 0;
    user-select: none;
  }
  .order {
    font-weight: normal;
    font-size: 14px;
  }
  @media (max-width: 650px) {
    body {
      flex-direction: column;
      padding: 8px;
      gap: 8px;
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    #leftPanel {
      width: 100%;
      max-width: 100vw;
      min-width: unset;
      padding: 8px !important;
      box-sizing: border-box;
    }
    #farm {
      grid-template-columns: repeat(3, 1fr);
      min-height: 220px;
      grid-gap: 5px;
    }
    .plot {
      width: 60px;
      height: 60px;
      font-size: 22px;
    }
    .plot.grown {
      font-size: 28px;
    }
    #bugFarm {
      width: 98vw;
      height: 210px;
      margin: 0 auto 10px;
    }
    #animalFarm {
      width: 98vw;
      max-width: unset;
    }
    #pagination button {
      width: 28px;
      font-size: 14px;
      padding: 3px 0;
    }
    button {
      font-size: 14px;
      padding: 8px 6px;
    }
    #marketModal, #marketPricesModal, #storeModal {
      width: 98vw !important;
      min-width: unset;
      max-width: 420px;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 10px;
    }
  }
</style>
</head>
<body>

<div id="leftPanel">
  <h1 id="farmTitle">√áiftlik üåæ</h1>
  <div id="info">G√ºn: 1 | Para: 100‚Ç∫ | Seviye: 1 | Versiyon: 2.1.0</div>
  
  <div id="xpBarContainer">
    <div id="xpBar"></div>
  </div>
  
  <div id="message"></div>

  <div id="inventory"></div>

  <div id="pagination">
    <button id="prevPageBtn" disabled>‚Üê</button>
    <span id="pageIndicator">Tarla 1 / 5</span>
    <button id="nextPageBtn">‚Üí</button>
  </div>

  <div id="farm"></div>

  <div id="bugFarm" style="display:none;" title="B√∂cek Tarlasƒ±"></div>
  
  <div id="animalFarm" style="display:none;"></div>
  
  <div id="storePage" style="display:none;">
    <button id="storeRentBtn">D√ºkkan Kirala - 1000‚Ç∫</button>
    <div id="storeMarketItems"></div>
    <div id="customers"></div>
  </div>

  <div id="controls">
    <button id="openMarketBtn">Market A√ß</button>
    <button id="openMarketPricesBtn">Piyasa A√ß</button>
    <button id="newGameBtn">Yeni Oyun</button>
  </div>
</div>

<div id="marketOverlay"></div>

<div id="marketModal">
  <h2>Market</h2>
  <h3>Tohumlar</h3>
  <div id="marketSeeds"></div>
  
  <h3>T√ºketilebilirler</h3>
  <div id="marketConsumables"></div>

  <h3>B√∂cekler</h3>
  <div id="marketBugs"></div>
  <h3>G√º√ßlendiriciler</h3>
  <div id="marketEnhancers"></div>
  <h3>Hayvanlar</h3>
  <div id="marketAnimals"></div>
  <div id="seedInventory">
    <p>Tohumlarƒ±nƒ±z:</p>
    <ul id="seedList"></ul>
    <p>G√º√ßlendiriciler:</p>
    <ul id="enhancerList"></ul>
  </div>
  <button id="closeMarketBtn" style="margin-top:15px;">Kapat</button>
</div>

<div id="marketPricesModal">
  <h2>Piyasa</h2>
  <div id="marketPricesList"></div>
  <button id="closeMarketPricesBtn" style="margin-top:15px;">Kapat</button>
</div>

<div id="storeModal" style="display:none;">
  <h2>D√ºkkan Marketi</h2>
  <div id="storeMarketItems"></div>
  <button id="closeStoreBtn" style="margin-top:15px;">Kapat</button>
</div>

<script>
  const sounds = {
    plant: new Audio('sounds/plant.wav'),
    harvest: new Audio('sounds/harvest.wav'),
    buy: new Audio('sounds/buy.wav'),
    pageChange: new Audio('sounds/pageChange.wav'),
    levelUp: new Audio('sounds/levelUp.wav') // YENƒ∞Lƒ∞K: Seviye atlama sesi
  };

  const GAME_VERSION = '2.1.0'; // YENƒ∞Lƒ∞K: S√ºr√ºm g√ºncellendi

  const infoEl = document.getElementById('info');
  const messageEl = document.getElementById('message');
  const inventoryEl = document.getElementById('inventory');
  const farmEl = document.getElementById('farm');
  const bugFarmEl = document.getElementById('bugFarm');
  const animalFarmEl = document.getElementById('animalFarm');
  const storePageEl = document.getElementById('storePage');
  const storeRentBtn = document.getElementById('storeRentBtn');
  const storeMarketItemsDiv = document.getElementById('storeMarketItems');
  const customersEl = document.getElementById('customers');
  const openMarketBtn = document.getElementById('openMarketBtn');
  const openMarketPricesBtn = document.getElementById('openMarketPricesBtn');
  const marketModal = document.getElementById('marketModal');
  const marketOverlay = document.getElementById('marketOverlay');
  const closeMarketBtn = document.getElementById('closeMarketBtn');
  const marketSeedsDiv = document.getElementById('marketSeeds');
  const marketBugsDiv = document.getElementById('marketBugs');
  const marketEnhancersDiv = document.getElementById('marketEnhancers');
  const marketAnimalsDiv = document.getElementById('marketAnimals');
  const marketConsumablesDiv = document.getElementById('marketConsumables'); // YENƒ∞Lƒ∞K
  const seedListEl = document.getElementById('seedList');
  const enhancerListEl = document.getElementById('enhancerList');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const pageIndicator = document.getElementById('pageIndicator');
  const marketPricesModal = document.getElementById('marketPricesModal');
  const marketPricesList = document.getElementById('marketPricesList');
  const closeMarketPricesBtn = document.getElementById('closeMarketPricesBtn');
  const newGameBtn = document.getElementById('newGameBtn');
  const farmTitle = document.getElementById('farmTitle');
  const storeModal = document.getElementById('storeModal');
  const closeStoreBtn = document.getElementById('closeStoreBtn');
  const xpBar = document.getElementById('xpBar'); // YENƒ∞Lƒ∞K
  
  const farmPagesCount = 5;
  const farmSize = 5;
  const MS_IN_MINUTE = 60000;
  const MS_IN_HALF_HOUR = 1800000;
  const MS_IN_6_HOURS = 21600000;

  const crops = {
    corn:    { name: 'Mƒ±sƒ±r', growTimeMinutes: 20, price: 15, emoji: 'üåΩ', seedPrice: 10, xp: 5 },
    tomato:  { name: 'Domates', growTimeMinutes: 16, price: 10, emoji: 'üçÖ', seedPrice: 8, xp: 4 },
    carrot:  { name: 'Havu√ß', growTimeMinutes: 45, price: 12, emoji: 'ü•ï', seedPrice: 9, xp: 8 },
    wheat:   { name: 'Buƒüday', growTimeMinutes: 60, price: 18, emoji: 'üåæ', seedPrice: 14, xp: 10 },
    pepper:  { name: 'Biber', growTimeMinutes: 25, price: 20, emoji: 'üå∂Ô∏è', seedPrice: 15, xp: 6 }
  };

  const flowers = {
    rose:      { name: 'G√ºl', growTimeMinutes: 8, price: 11, emoji: 'üåπ', seedPrice: 9, xp: 3 },
    tulip:     { name: 'Lale', growTimeMinutes: 7, price: 10, emoji: 'üå∑', seedPrice: 9, xp: 3 },
    daisy:     { name: 'Papatya', growTimeMinutes: 5, price: 11, emoji: 'üåº', seedPrice: 9, xp: 2 },
    sunflower: { name: 'Ay√ßi√ßeƒüi', growTimeMinutes: 9, price: 12, emoji: 'üåª', seedPrice: 15, xp: 4 },
    orchid:    { name: 'Orkide', growTimeMinutes: 10, price: 13, emoji: 'üíê', seedPrice: 9, xp: 4 }
  };

  const bugs = {
    spider:      { name: '√ñr√ºmcek', emoji: 'üï∑Ô∏è', price: 1000 },
    ladybug:     { name: 'Uƒüur B√∂ceƒüi', emoji: 'üêû', price: 1000 },
    ant:         { name: 'Karƒ±nca', emoji: 'üêú', price: 1000 },
    beetle:      { name: 'B√∂cek', emoji: 'üêõ', price: 1100 },
    caterpillar: { name: 'Tƒ±rtƒ±l', emoji: 'üêõ', price: 1200 },
    centipede:   { name: 'Kƒ±rkayak', emoji: 'üêõ', price: 1300 },
    mantis:      { name: 'Sinek Kapan', emoji: 'ü¶ó', price: 1400 }
  };

  const enhancers = {
    fastHarvest:   { name: 'Hƒ±zlƒ± Hasat G√º√ßlendirici', description: 'Ekinlerin olgunla≈üma s√ºresi %20 azalƒ±r.', price: 5000 },
    fertileSoil:   { name: 'Verimli Toprak', description: 'Hasattan elde edilen para %20 artar.', price: 9000 },
    richSeed:      { name: 'Zengin Tohum', description: 'Hasatta %30 ihtimalle +1 ek √ºr√ºn verir.', price: 12000 },
    freshKeeper:   { name: 'Tazelik Koruyucu', description: 'Bozulma s√ºresini 48 saate √ßƒ±karƒ±r.', price: 8000 }
  };

  const animals = {
    chicken: { name: 'Tavuk', emoji: 'üêî', buyPrice: 300, productPrice: 25, xp: 15 },
    cow:     { name: 'ƒ∞nek', emoji: 'üêÑ', buyPrice: 500, productPrice: 50, xp: 30 },
    goat:    { name: 'Ke√ßi', emoji: 'üêê', buyPrice: 1200, productPrice: 120, xp: 50 }
  };

  // YENƒ∞Lƒ∞K: T√ºketilebilir e≈üyalar
  const consumables = {
    superFertilizer: { name: 'S√ºper G√ºbre', emoji: 'üß™', price: 250, description: 'Ektiƒüiniz bir bitkinin anƒ±nda b√ºy√ºmesini saƒülar.' }
  };

  const storeProducts = {
    danaEti: { name: 'Dana Eti', buyPrice: 10 },
    hamburgerEkmegi: { name: 'Hamburger Ekmeƒüi', buyPrice: 10 },
    sosis: { name: 'Sosis', buyPrice: 5 },
    sosisliEkmegi: { name: 'Sosisli Ekmeƒüi', buyPrice: 2 },
    ayran: { name: 'Ayran', buyPrice: 5, sellPrice: 10 },
    kola: { name: 'Kola', buyPrice: 8, sellPrice: 12 }
  };

  let money = 100;
  
  // YENƒ∞Lƒ∞K: Seviye sistemi i√ßin deƒüi≈ükenler
  let level = 1;
  let xp = 0;
  let xpToNextLevel = 100;

  let seeds = { corn: 5, tomato: 5, carrot: 2, wheat: 1, pepper: 1 };
  let flowerSeeds = { rose: 3, tulip: 3, daisy: 3, sunflower: 1, orchid: 1 };
  let purchasedBugs = {};
  let purchasedEnhancers = {};
  let ownedAnimals = { chicken: 0, cow: 0, goat: 0 };
  let animalHarvestReady = { chicken: false, cow: false, goat: false };
  let animalLastHarvest = { chicken: 0, cow: 0, goat: 0 };

  // YENƒ∞Lƒ∞K: T√ºketilebilir e≈üya envanteri
  let ownedConsumables = {
    superFertilizer: 0
  };

  let storeRented = false;
  let storeRentStart = 0;
  let storeStock = {
    danaEti: 0, hamburgerEkmegi: 0, sosis: 0, sosisliEkmegi: 0, ayran: 0, kola: 0
  };

  let customers = [];
  let customerCounter = 0;

  let farms = [];
  for(let i=0; i<farmPagesCount-1; i++) {
    let pageFarm = [];
    for(let j=0; j<farmSize*farmSize; j++) {
      pageFarm.push({ state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 });
    }
    farms.push(pageFarm);
  }
  farms.push([{ bugType: null, x: 0, y: 0 }]);

  let currentFarmPage = 0;
  let selectedItem = null; // YENƒ∞Lƒ∞K: selectedSeedKey -> selectedItem olarak genelle≈ütirildi
  let selectedItemType = 'seed'; // YENƒ∞Lƒ∞K: 'seed', 'consumable' vs. olabilir

  const allProducts = {...crops, ...flowers};

  let marketPrices = {};
  let previousMarketPrices = {};
  let marketLastUpdatedDay = null;

  function getCurrentGameDay() {
    const now = new Date();
    return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
  }
  
  // YENƒ∞Lƒ∞K: XP ekleme ve seviye atlama fonksiyonu
  function addXp(amount) {
    xp += amount;
    if (xp >= xpToNextLevel) {
      level++;
      xp = xp - xpToNextLevel;
      xpToNextLevel = Math.floor(xpToNextLevel * 1.5); // Sonraki seviye i√ßin gereken XP'yi arttƒ±r
      showMessage(`üéâ Seviye atladƒ±n! Yeni seviyen: ${level} üéâ`);
      sounds.levelUp.play();
    }
    updateInfo(); // Bilgi ve XP barƒ±nƒ± g√ºncelle
  }

  function updateMarketPrices() {
    const currentDay = getCurrentGameDay();
    if(currentDay === marketLastUpdatedDay) return;
    marketLastUpdatedDay = currentDay;
    previousMarketPrices = {...marketPrices};
    Object.keys(crops).forEach(key => {
      let basePrice = crops[key].price;
      let change = 0;
      if(Math.random() < 0.10) change = -0.10;
      else if(Math.random() < 0.05) change = 1.00;
      else change = (Math.random() * 0.6) - 0.10;
      let price = Math.max(1, Math.floor(basePrice * (1 + change)));
      marketPrices[key] = price;
    });
    Object.keys(flowers).forEach(key => {
      const price = Math.floor(Math.random() * (8 - 4 + 1)) + 4;
      marketPrices[key] = price;
    });
  }

  function profitEmoji(todayPrice, yesterdayPrice) {
    if(yesterdayPrice === undefined) return '‚ûñ';
    if(todayPrice > yesterdayPrice) return '‚¨ÜÔ∏è';
    if(todayPrice < yesterdayPrice) return '‚¨áÔ∏è';
    return '‚ûñ';
  }

  function openMarketPrices() {
    renderMarketPrices();
    marketPricesModal.style.display = 'block';
    marketOverlay.style.display = 'block';
  }

  function closeMarketPrices() {
    marketPricesModal.style.display = 'none';
    marketOverlay.style.display = 'none';
  }

  function renderMarketPrices() {
    marketPricesList.innerHTML = '';
    for(const key in marketPrices) {
      const p = document.createElement('p');
      const product = allProducts[key];
      const emoji = profitEmoji(marketPrices[key], previousMarketPrices[key]);
      const seedPrice = product.seedPrice !== undefined ? product.seedPrice : product.price;
      p.innerHTML = `${product.emoji} ${product.name}: ${marketPrices[key]}‚Ç∫ (Normal: ${seedPrice}‚Ç∫) <span class="profit-emoji">${emoji}</span>`;
      marketPricesList.appendChild(p);
    }
  }

  function drawInventory() {
    inventoryEl.innerHTML = '';
    
    // Tohumlarƒ± √ßiz
    const sourceSeeds = currentFarmPage === 1 ? flowerSeeds : seeds;
    const sourceCrops = currentFarmPage === 1 ? flowers : crops;

    for(const key in sourceSeeds) {
        if(sourceSeeds[key] > 0) {
            const btn = document.createElement('div');
            btn.className = 'inv-item';
            if(selectedItem === key && selectedItemType === 'seed') btn.classList.add('selected');
            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = sourceCrops[key].emoji;
            emojiSpan.style.fontSize = '32px';
            const countSpan = document.createElement('span');
            countSpan.className = 'inv-count';
            countSpan.textContent = sourceSeeds[key];
            btn.title = `${sourceCrops[key].name} (${sourceSeeds[key]} adet)`;
            btn.onclick = () => {
                selectedItem = key;
                selectedItemType = 'seed';
                drawInventory();
                showMessage(`${sourceCrops[key].name} se√ßildi.`);
            };
            btn.appendChild(emojiSpan);
            btn.appendChild(countSpan);
            inventoryEl.appendChild(btn);
        }
    }
    
    // YENƒ∞Lƒ∞K: T√ºketilebilirleri √ßiz
    for (const key in ownedConsumables) {
        if (ownedConsumables[key] > 0) {
            const itemData = consumables[key];
            const btn = document.createElement('div');
            btn.className = 'inv-item';
            if (selectedItem === key && selectedItemType === 'consumable') btn.classList.add('selected');
            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = itemData.emoji;
            emojiSpan.style.fontSize = '32px';
            const countSpan = document.createElement('span');
            countSpan.className = 'inv-count';
            countSpan.textContent = ownedConsumables[key];
            btn.title = `${itemData.name} (${ownedConsumables[key]} adet)`;
            btn.onclick = () => {
                selectedItem = key;
                selectedItemType = 'consumable';
                drawInventory();
                showMessage(`${itemData.name} se√ßildi.`);
            };
            btn.appendChild(emojiSpan);
            btn.appendChild(countSpan);
            inventoryEl.appendChild(btn);
        }
    }
  }
  

  function drawEnhancerList() {
    enhancerListEl.innerHTML = '';
    for(const key in purchasedEnhancers) {
      if(purchasedEnhancers[key]) {
        const li = document.createElement('li');
        li.textContent = enhancers[key].name;
        enhancerListEl.appendChild(li);
      }
    }
  }

  function drawFarm() {
    farmEl.innerHTML = '';
    bugFarmEl.style.display = 'none';
    animalFarmEl.style.display = 'none';
    storePageEl.style.display = 'none';

    if(currentFarmPage === farmPagesCount - 1) {
      farmEl.style.display = 'none';
      bugFarmEl.style.display = 'block';
      animalFarmEl.style.display = 'none';
      pageIndicator.textContent = `Tarla ${currentFarmPage + 1} / ${farmPagesCount}`;
      prevPageBtn.disabled = false;
      nextPageBtn.disabled = true;
      drawBugs();
      return;
    }

    if(currentFarmPage === farmPagesCount - 2) {
      farmEl.style.display = 'none';
      bugFarmEl.style.display = 'none';
      animalFarmEl.style.display = 'flex';
      pageIndicator.textContent = `Tarla ${currentFarmPage + 1} / ${farmPagesCount}`;
      prevPageBtn.disabled = false;
      nextPageBtn.disabled = false;
      drawAnimals();
      return;
    }

    if(currentFarmPage === farmPagesCount - 3) {
      farmEl.style.display = 'none';
      bugFarmEl.style.display = 'none';
      animalFarmEl.style.display = 'none';
      storePageEl.style.display = 'flex';
      pageIndicator.textContent = `D√ºkkan ${currentFarmPage + 1} / ${farmPagesCount}`;
      prevPageBtn.disabled = false;
      nextPageBtn.disabled = false;
      drawStorePage();
      return;
    }

    farmEl.style.display = 'grid';
    const farm = farms[currentFarmPage];
    farm.forEach((plot, i) => {
      const plotEl = document.createElement('div');
      plotEl.classList.add('plot');
      if(currentFarmPage === 1) plotEl.style.backgroundColor = '#7a4f8a';
      if(plot.state === 'empty') {
        plotEl.style.backgroundColor = currentFarmPage === 1 ? '#7a4f8a' : '#7b4f24';
        plotEl.textContent = '';
      } else {
        const isReady = isPlotReady(plot);
        if(isReady) plotEl.classList.add('grown');
        else plotEl.classList.add('planted');
        const emoji = currentFarmPage === 1 ? flowers[plot.cropType]?.emoji || '' : crops[plot.cropType]?.emoji || '';
        const emojiSpan = document.createElement('span');
        emojiSpan.textContent = emoji;
        emojiSpan.style.display = 'block';
        emojiSpan.style.fontSize = currentFarmPage === 1 ? '36px' : '40px';
        emojiSpan.style.lineHeight = '1';
        const timeSpan = document.createElement('span');
        timeSpan.style.display = 'block';
        timeSpan.style.fontSize = '14px';
        timeSpan.style.marginTop = '2px';
        timeSpan.style.fontWeight = 'bold';
        timeSpan.style.color = '#c5e1a5';
        timeSpan.dataset.plotIndex = i;
        plotEl.appendChild(emojiSpan);
        plotEl.appendChild(timeSpan);
      }
      plotEl.onclick = () => handlePlotClick(i, plot); // YENƒ∞Lƒ∞K: Ayrƒ± bir fonksiyona ta≈üƒ±ndƒ±
      farmEl.appendChild(plotEl);
    });
    pageIndicator.textContent = `Tarla ${currentFarmPage + 1} / ${farmPagesCount}`;
    prevPageBtn.disabled = currentFarmPage === 0;
    nextPageBtn.disabled = currentFarmPage === farmPagesCount - 1;
    updateTimeInPlots();
  }
  
  // YENƒ∞Lƒ∞K: Tarla tƒ±klama mantƒ±ƒüƒ±nƒ± y√∂neten fonksiyon
  function handlePlotClick(index, plot) {
    if (selectedItemType === 'consumable' && selectedItem === 'superFertilizer') {
        if (plot.state === 'planted' && !isPlotReady(plot)) {
            useSuperFertilizer(index);
        } else {
            showMessage('S√ºper G√ºbre sadece ekili ve b√ºy√ºmemi≈ü bitkilerde kullanƒ±lƒ±r!');
        }
        return;
    }

    // Normal tohum ekme/hasat etme mantƒ±ƒüƒ±
    if(plot.state === 'empty') {
        if (selectedItemType === 'seed' && selectedItem) {
            plantCrop(index, selectedItem);
        } else {
            showMessage('L√ºtfen envanterden bir tohum se√ßin!');
        }
    } else {
      if(isPlotReady(plot)) {
        harvestCrop(index);
      } else if(isPlotSpoiled(plot)) {
        showMessage('Bu √ºr√ºn bozuldu, hasat edemezsin!');
      } else {
        showMessage('Ekin b√ºy√ºyor, sabƒ±rlƒ± ol!');
      }
    }
  }


  function drawAnimals() {
    animalFarmEl.innerHTML = '';
    Object.keys(animals).forEach(key => {
      const animal = animals[key];
      const count = ownedAnimals[key];
      const div = document.createElement('div');
      div.className = 'animal';
      div.title = animal.name;
      const emojiSpan = document.createElement('span');
      emojiSpan.className = 'animal-emoji';
      emojiSpan.textContent = animal.emoji;
      const countSpan = document.createElement('span');
      countSpan.className = 'animal-count';
      countSpan.textContent = `Adet: ${count}`;
      const harvestSpan = document.createElement('span');
      harvestSpan.className = 'harvest-status';
      if(count > 0) {
        if(animalHarvestReady[key]) {
          harvestSpan.textContent = 'Hasat hazƒ±r!';
        } else {
          const now = Date.now();
          const elapsed = now - animalLastHarvest[key];
          const remaining = MS_IN_HALF_HOUR - elapsed;
          if(remaining > 0) {
            const min = Math.floor(remaining / 60000);
            const sec = Math.floor((remaining % 60000) / 1000);
            harvestSpan.textContent = `Hasat: ${min}:${sec.toString().padStart(2,'0')}`;
          } else {
            harvestSpan.textContent = 'Hasat hazƒ±r!';
          }
        }
      } else {
        harvestSpan.textContent = '';
      }
      div.appendChild(emojiSpan);
      div.appendChild(countSpan);
      div.appendChild(harvestSpan);
      div.onclick = () => {
        if(count === 0) {
          showMessage(`${animal.name} satƒ±n alƒ±nmamƒ±≈ü!`);
          return;
        }
        if(animalHarvestReady[key]) {
          const totalIncome = count * animal.productPrice;
          money += totalIncome;
          animalHarvestReady[key] = false;
          animalLastHarvest[key] = Date.now();
          addXp(animal.xp * count); // YENƒ∞Lƒ∞K: Hayvan hasadƒ±ndan XP kazan
          showMessage(`${animal.name} hasat edildi! +${totalIncome}‚Ç∫ ve ${animal.xp * count} XP!`);
          updateInfo();
          drawAnimals();
          saveGameAuto();
          sounds.harvest.play();
        } else {
          showMessage(`${animal.name} i√ßin hasat hazƒ±r deƒüil.`);
        }
      };
      animalFarmEl.appendChild(div);
    });
  }

  function drawStorePage() {
    storeMarketItemsDiv.innerHTML = '';
    customersEl.innerHTML = '';
    storeRentBtn.textContent = storeRented
      ? `D√ºkkan kiralandƒ±! Kira biti≈ü: ${new Date(storeRentStart + MS_IN_6_HOURS).toLocaleTimeString()}`
      : 'D√ºkkan Kirala - 1000‚Ç∫';
    storeRentBtn.disabled = storeRented || (money !== Infinity && money < 1000);
    let stockHtml = '<b>D√ºkkan Stoƒüu:</b><br>';
    for (const key in storeStock) stockHtml += `${storeProducts[key].name}: ${storeStock[key]}<br>`;
    storeMarketItemsDiv.innerHTML = stockHtml;
    for (const key in storeProducts) {
      const product = storeProducts[key];
      const btn = document.createElement('button');
      btn.textContent = `Satƒ±n Al: ${product.name} - ${product.buyPrice}‚Ç∫`;
      btn.disabled = !(money === Infinity || money >= product.buyPrice) || !storeRented;
      btn.onclick = () => buyStoreItem(key);
      storeMarketItemsDiv.appendChild(btn);
    }
    if(storeRented && customers.length > 0) {
      customers.forEach((customer, index) => {
        const custDiv = document.createElement('div');
        custDiv.className = 'customer';
        custDiv.textContent = `M√º≈üteri`;
        const orderNames = customer.orders.map(o => o.charAt(0).toUpperCase() + o.slice(1)).join(' ve ');
        const orderP = document.createElement('p');
        orderP.className = 'order';
        orderP.textContent = `${orderNames} istiyor.`;
        custDiv.appendChild(orderP);
        custDiv.onclick = () => deliverOrder(index);
        customersEl.appendChild(custDiv);
      });
    }
  }

  function buyStoreItem(key) {
    if(!storeRented) {
      showMessage('√ñnce d√ºkkanƒ± kiralamalƒ±sƒ±n!');
      return;
    }
    const product = storeProducts[key];
    if(money === Infinity || money >= product.buyPrice) {
      if(money !== Infinity) money -= product.buyPrice;
      storeStock[key]++;
      sounds.buy.play();
      showMessage(`${product.name} satƒ±n alƒ±ndƒ±.`);
      updateInfo();
      drawStorePage();
      saveGameAuto();
    } else {
      showMessage('Paran yetmiyor!');
    }
  }

  function deliverOrder(customerIndex) {
    if(customerIndex >= customers.length) return;
    const customer = customers[customerIndex];
    const order = customer.orders;
    let canDeliver = true;
    order.forEach(item => {
      if(item === 'hamburger') {
        if(storeStock['danaEti'] < 1 || storeStock['hamburgerEkmegi'] < 1) canDeliver = false;
      } else if(item === 'sosisli') {
        if(storeStock['sosis'] < 1 || storeStock['sosisliEkmegi'] < 1) canDeliver = false;
      } else if(storeStock[item] < 1) canDeliver = false;
    });
    if(!canDeliver) {
      showMessage('Sipari≈üi teslim etmek i√ßin yeterli malzemen yok!');
      return;
    }
    order.forEach(item => {
      if(item === 'hamburger') {
        storeStock['danaEti']--; storeStock['hamburgerEkmegi']--;
      } else if(item === 'sosisli') {
        storeStock['sosis']--; storeStock['sosisliEkmegi']--;
      } else {
        storeStock[item]--;
      }
    });
    let totalGain = 0;
    let totalXp = 0; // YENƒ∞Lƒ∞K: Sipari≈üten kazanƒ±lacak XP
    order.forEach(item => {
      if(item === 'hamburger') { totalGain += 30; totalXp += 20; }
      else if(item === 'sosisli') { totalGain += 12; totalXp += 10; }
      else if(storeProducts[item].sellPrice) { totalGain += storeProducts[item].sellPrice; totalXp += 5;}
    });
    money += totalGain;
    addXp(totalXp); // YENƒ∞Lƒ∞K: XP ekle
    showMessage(`Sipari≈ü teslim edildi! +${totalGain}‚Ç∫ ve ${totalXp} XP!`);
    customers.splice(customerIndex, 1);
    addNewCustomer();
    updateInfo();
    drawStorePage();
    saveGameAuto();
  }

  function addNewCustomer() {
    const possibleOrders = ['hamburger', 'kola', 'ayran', 'sosisli'];
    const orderCount = Math.floor(Math.random() * 2) + 1;
    let orders = [];
    while (orders.length < orderCount) {
      const item = possibleOrders[Math.floor(Math.random() * possibleOrders.length)];
      if(!orders.includes(item)) orders.push(item);
    }
    customerCounter++;
    customers.push({ id: customerCounter, orders });
  }

  function updateTimeInPlots() {
    const farm = farms[currentFarmPage];
    const now = Date.now();
    const plotTimeSpans = farmEl.querySelectorAll('span[data-plot-index]');
    plotTimeSpans.forEach(span => {
      const i = parseInt(span.dataset.plotIndex);
      const plot = farm[i];
      if(!plot || plot.state !== 'planted' || !plot.plantedAt) {
        span.textContent = '';
        return;
      }
      const growTimeMs = getEffectiveGrowTime(plot) * MS_IN_MINUTE;
      const elapsedMs = now - plot.plantedAt;
      const remainingMs = growTimeMs - elapsedMs;
      if(isPlotSpoiled(plot)) {
        span.textContent = 'BOZULDU!';
        span.style.color = '#b71c1c';
      } else if(isPlotReady(plot)) {
        span.textContent = 'Hasat hazƒ±r!';
        span.style.color = '#aed581';
      } else {
        const remSec = Math.max(0, Math.floor(remainingMs / 1000));
        const remMin = Math.floor(remSec / 60);
        const remS = remSec % 60;
        span.textContent = `${remMin}:${remS.toString().padStart(2,'0')}`;
        span.style.color = '#c5e1a5';
      }
    });
  }

  function updateAnimalHarvestStatus() {
    const now = Date.now();
    Object.keys(ownedAnimals).forEach(key => {
      if(ownedAnimals[key] > 0) {
        if(animalLastHarvest[key] === 0) animalHarvestReady[key] = false;
        else animalHarvestReady[key] = (now - animalLastHarvest[key]) >= MS_IN_HALF_HOUR;
      } else {
        animalHarvestReady[key] = false; animalLastHarvest[key] = 0;
      }
    });
  }

  function isPlotReady(plot) {
    if(plot.state !== 'planted' || !plot.plantedAt) return false;
    const now = Date.now();
    const elapsedMinutes = (now - plot.plantedAt) / MS_IN_MINUTE;
    return elapsedMinutes >= getEffectiveGrowTime(plot);
  }

  function getEffectiveGrowTime(plot) {
    let t = plot.growTimeMinutes;
    if(purchasedEnhancers.fastHarvest) t = Math.floor(t * 0.8);
    return t;
  }

  function isPlotSpoiled(plot) {
    if(plot.state !== 'planted' || !plot.plantedAt) return false;
    const now = Date.now();
    const elapsedMinutes = (now - plot.plantedAt) / MS_IN_MINUTE;
    const readyTime = getEffectiveGrowTime(plot);
    const maxHours = purchasedEnhancers.freshKeeper ? 48 : 24;
    const spoilMinutes = maxHours * 60;
    return elapsedMinutes >= (readyTime + spoilMinutes);
  }

  function plantCrop(index, cropKey) {
    let sourceSeeds, cropData, isValidPlanting = false;

    if (currentFarmPage === 1 && flowers[cropKey]) {
        sourceSeeds = flowerSeeds;
        cropData = flowers[cropKey];
        isValidPlanting = true;
    } else if (currentFarmPage !== 1 && crops[cropKey]) {
        sourceSeeds = seeds;
        cropData = crops[cropKey];
        isValidPlanting = true;
    }

    if (!isValidPlanting) {
        showMessage('Bu tohumu bu tarlaya ekemezsin!');
        return;
    }

    if(sourceSeeds[cropKey] <= 0) {
      showMessage('Bu tohumdan stokta kalmadƒ±!');
      return;
    }
    
    let farm = farms[currentFarmPage];
    farm[index] = {
      state: 'planted', cropType: cropKey, plantedAt: Date.now(), growTimeMinutes: cropData.growTimeMinutes
    };
    sourceSeeds[cropKey]--;
    sounds.plant.play();
    showMessage(`${cropData.name} ektin!`);
    updateInfo();
    drawInventory();
    drawFarm();
    saveGameAuto();
  }

  // YENƒ∞Lƒ∞K: S√ºper G√ºbre kullanma fonksiyonu
  function useSuperFertilizer(index) {
    if (ownedConsumables.superFertilizer <= 0) {
        showMessage('Hi√ß S√ºper G√ºbren yok!');
        return;
    }
    let farm = farms[currentFarmPage];
    const plot = farm[index];
    const growTimeMs = getEffectiveGrowTime(plot) * MS_IN_MINUTE;
    
    plot.plantedAt = Date.now() - growTimeMs; // B√ºy√ºme s√ºresini tamamlamƒ±≈ü gibi yap
    
    ownedConsumables.superFertilizer--;
    
    showMessage(`${allProducts[plot.cropType].name} anƒ±nda b√ºy√ºd√º!`);
    sounds.plant.play();
    updateInfo();
    drawInventory();
    drawFarm();
    saveGameAuto();
  }

  function harvestCrop(index) {
    let farm = farms[currentFarmPage];
    const plot = farm[index];
    const cropKey = plot.cropType;
    let cropData = currentFarmPage === 1 ? flowers[cropKey] : crops[cropKey];

    if(isPlotSpoiled(plot)) {
      farm[index] = { state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 };
      showMessage(`${cropData.name} bozulmu≈ü, hasat edilemedi! üò¢`);
      drawFarm();
      saveGameAuto();
      return;
    }

    let gain;
    if(currentFarmPage === 1) gain = Math.max(cropData.price, cropData.seedPrice + 20);
    else {
      gain = marketPrices[cropKey] || cropData.price;
      if(purchasedEnhancers.fertileSoil) gain = Math.floor(gain * 1.2);
    }

    let extra = 0;
    if(purchasedEnhancers.richSeed && Math.random() < 0.3) extra = 1;
    let totalGain = gain * (1 + extra);
    
    money = money === Infinity ? money : money + totalGain;
    addXp(cropData.xp * (1 + extra)); // YENƒ∞Lƒ∞K: Hasattan XP kazan
    farm[index] = { state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 };
    sounds.harvest.play();
    if(extra)
      showMessage(`${cropData.name} hasat edildi! +${totalGain}‚Ç∫ ve ${cropData.xp * (1 + extra)} XP! (BONUS!)`);
    else
      showMessage(`${cropData.name} hasat edildi! +${gain}‚Ç∫ ve ${cropData.xp} XP!`);
    updateInfo();
    drawFarm();
    saveGameAuto();
  }

  function openMarket() {
    marketModal.style.display = 'block';
    marketOverlay.style.display = 'block';
    renderMarketSeeds();
    renderMarketConsumables(); // YENƒ∞Lƒ∞K
    renderMarketBugs();
    renderMarketEnhancers();
    renderMarketAnimals();
    updateSeedInventory();
    drawEnhancerList();
  }

  function closeMarket() {
    marketModal.style.display = 'none';
    marketOverlay.style.display = 'none';
  }

  function renderMarketSeeds() {
    marketSeedsDiv.innerHTML = '';
    for(const key in crops) {
      const btn = document.createElement('button');
      btn.classList.add('seedBtn');
      btn.textContent = `${crops[key].emoji} ${crops[key].name} Tohumu - ${crops[key].seedPrice}‚Ç∫`;
      btn.disabled = money !== Infinity && money < crops[key].seedPrice;
      btn.onclick = () => buySeed(key);
      marketSeedsDiv.appendChild(btn);
    }
    for(const key in flowers) {
      const btn = document.createElement('button');
      btn.classList.add('seedBtn');
      btn.textContent = `${flowers[key].emoji} ${flowers[key].name} Tohumu - ${flowers[key].seedPrice}‚Ç∫`;
      btn.disabled = money !== Infinity && money < flowers[key].seedPrice;
      btn.onclick = () => buySeedFlower(key);
      marketSeedsDiv.appendChild(btn);
    }
  }

  // YENƒ∞Lƒ∞K: T√ºketilebilir marketini render etme
  function renderMarketConsumables() {
    marketConsumablesDiv.innerHTML = '';
    for(const key in consumables) {
      const item = consumables[key];
      const btn = document.createElement('button');
      btn.classList.add('consumableBtn');
      btn.textContent = `${item.emoji} ${item.name} - ${item.price}‚Ç∫`;
      btn.disabled = money !== Infinity && money < item.price;
      btn.title = item.description;
      btn.onclick = () => buyConsumable(key);
      marketConsumablesDiv.appendChild(btn);
    }
  }
  
  // YENƒ∞Lƒ∞K: T√ºketilebilir satƒ±n alma
  function buyConsumable(key) {
    const item = consumables[key];
    if (money === Infinity || money >= item.price) {
        if (money !== Infinity) money -= item.price;
        ownedConsumables[key]++;
        sounds.buy.play();
        showMessage(`${item.name} satƒ±n aldƒ±n.`);
        updateInfo();
        drawInventory();
        renderMarketConsumables(); // Buton durumunu g√ºncelle
        saveGameAuto();
    } else {
        showMessage('Paran yetmiyor!');
    }
  }

  function buySeed(seedKey) {
    if(money === Infinity || money >= crops[seedKey].seedPrice) {
      if(money !== Infinity) money -= crops[seedKey].seedPrice;
      seeds[seedKey]++;
      sounds.buy.play();
      showMessage(`${crops[seedKey].name} tohumu satƒ±n aldƒ±n.`);
      updateInfo();
      drawInventory();
      renderMarketSeeds();
      saveGameAuto();
      const btns = marketSeedsDiv.querySelectorAll('button');
      btns.forEach(btn => { if(btn.textContent.includes(crops[seedKey].name)) flashButton(btn); });
    } else {
      showMessage('Paran yetmiyor!');
    }
  }
  function buySeedFlower(seedKey) {
    if(money === Infinity || money >= flowers[seedKey].seedPrice) {
      if(money !== Infinity) money -= flowers[seedKey].seedPrice;
      flowerSeeds[seedKey]++;
      sounds.buy.play();
      showMessage(`${flowers[seedKey].name} tohumu satƒ±n aldƒ±n.`);
      updateInfo();
      drawInventory();
      renderMarketSeeds();
      saveGameAuto();
      const btns = marketSeedsDiv.querySelectorAll('button');
      btns.forEach(btn => { if(btn.textContent.includes(flowers[seedKey].name)) flashButton(btn); });
    } else {
      showMessage('Paran yetmiyor!');
    }
  }

  function renderMarketBugs() {
    marketBugsDiv.innerHTML = '';
    for(const key in bugs) {
      const btn = document.createElement('button');
      btn.classList.add('bugBtn');
      btn.textContent = `${bugs[key].emoji} ${bugs[key].name} - ${bugs[key].price}‚Ç∫`;
      btn.disabled = purchasedBugs[key] || (money !== Infinity && money < bugs[key].price);
      btn.onclick = () => buyBug(key);
      marketBugsDiv.appendChild(btn);
    }
  }

  function buyBug(bugKey) {
    if(purchasedBugs[bugKey]) { showMessage('Bu b√∂ceƒüi zaten satƒ±n aldƒ±n!'); return; }
    if(money === Infinity || money >= bugs[bugKey].price) {
      if(money !== Infinity) money -= bugs[bugKey].price;
      purchasedBugs[bugKey] = true;
      sounds.buy.play();
      showMessage(`${bugs[bugKey].name} satƒ±n alƒ±ndƒ±!`);
      updateInfo(); renderMarketBugs(); drawBugs(); saveGameAuto();
      const btns = marketBugsDiv.querySelectorAll('button');
      btns.forEach(btn => { if(btn.textContent.includes(bugs[bugKey].name)) flashButton(btn); });
    } else { showMessage('Paran yetmiyor!'); }
  }

  function renderMarketEnhancers() {
    marketEnhancersDiv.innerHTML = '';
    for(const key in enhancers) {
      const btn = document.createElement('button');
      btn.classList.add('enhancerBtn');
      btn.textContent = `${enhancers[key].name} - ${enhancers[key].price}‚Ç∫`;
      btn.disabled = purchasedEnhancers[key] || (money !== Infinity && money < enhancers[key].price);
      btn.title = enhancers[key].description;
      btn.onclick = () => buyEnhancer(key);
      marketEnhancersDiv.appendChild(btn);
    }
  }

  function buyEnhancer(key) {
    if(purchasedEnhancers[key]) { showMessage('Bu g√º√ßlendiriciyi zaten satƒ±n aldƒ±n!'); return; }
    if(money === Infinity || money >= enhancers[key].price) {
      if(money !== Infinity) money -= enhancers[key].price;
      purchasedEnhancers[key] = true;
      sounds.buy.play();
      showMessage(`${enhancers[key].name} satƒ±n alƒ±ndƒ±!`);
      updateInfo(); renderMarketEnhancers(); drawEnhancerList(); saveGameAuto();
      const btns = marketEnhancersDiv.querySelectorAll('button');
      btns.forEach(btn => { if(btn.textContent.includes(enhancers[key].name)) flashButton(btn); });
    } else { showMessage('Paran yetmiyor!'); }
  }

  function renderMarketAnimals() {
    marketAnimalsDiv.innerHTML = '';
    for(const key in animals) {
      const btn = document.createElement('button');
      btn.classList.add('animalBtn');
      btn.textContent = `${animals[key].emoji} ${animals[key].name} - ${animals[key].buyPrice}‚Ç∫`;
      btn.disabled = money !== Infinity && money < animals[key].buyPrice;
      btn.onclick = () => buyAnimal(key);
      marketAnimalsDiv.appendChild(btn);
    }
  }

  function buyAnimal(animalKey) {
    if(money === Infinity || money >= animals[animalKey].buyPrice) {
      if(money !== Infinity) money -= animals[animalKey].buyPrice;
      ownedAnimals[animalKey]++;
      if(animalLastHarvest[animalKey] === 0) animalLastHarvest[animalKey] = Date.now();
      sounds.buy.play();
      showMessage(`${animals[animalKey].name} satƒ±n aldƒ±n.`);
      updateInfo(); drawAnimals(); renderMarketAnimals(); saveGameAuto();
      const btns = marketAnimalsDiv.querySelectorAll('button');
      btns.forEach(btn => { if(btn.textContent.includes(animals[animalKey].name)) flashButton(btn); });
    } else { showMessage('Paran yetmiyor!'); }
  }

  function flashButton(btn) {
    const originalBg = btn.style.backgroundColor;
    btn.style.backgroundColor = '#4caf50';
    setTimeout(() => { btn.style.backgroundColor = originalBg; }, 1000);
  }

  function updateSeedInventory() {
    seedListEl.innerHTML = '';
    for(const key in seeds) {
      const li = document.createElement('li');
      li.textContent = `${crops[key].name}: ${seeds[key]}`;
      seedListEl.appendChild(li);
    }
    for(const key in flowerSeeds) {
      const li = document.createElement('li');
      li.textContent = `${flowers[key].name}: ${flowerSeeds[key]}`;
      seedListEl.appendChild(li);
    }
  }

  function updateInfo() {
    let baseDay = localStorage.getItem("feyza_ciftligi_first_play_date");
    const today = getCurrentGameDay();
    if(!baseDay) { baseDay = today; localStorage.setItem("feyza_ciftligi_first_play_date", baseDay); }
    const dayCount = Math.floor((new Date(today) - new Date(baseDay)) / (1000*60*60*24)) + 1;
    let farmName = getFarmName() || "√áiftlik";
    if(farmName.toLowerCase().includes("vermidon")) { if(money < 100000) money = 100000; }
    
    // YENƒ∞Lƒ∞K: Bilgi ekranƒ±nƒ± g√ºncelle
    infoEl.textContent = `G√ºn: ${dayCount} | Para: ${formatMoney(money)} | Seviye: ${level} | Versiyon: ${GAME_VERSION}`;
    const xpPercentage = (xp / xpToNextLevel) * 100;
    xpBar.style.width = `${xpPercentage}%`;
    xpBar.textContent = `${Math.floor(xp)} / ${xpToNextLevel} XP`;
    
    farmTitle.textContent = `${farmName}`;
    document.title = `${farmName}`;
  }

  function formatMoney(m) {
    return m === Infinity ? '‚àû‚Ç∫' : `${m}‚Ç∫`;
  }

  function changePage(next) {
    if(next && currentFarmPage < farmPagesCount - 1) currentFarmPage++;
    else if(!next && currentFarmPage > 0) currentFarmPage--;
    selectedItem = null;
    selectedItemType = 'seed';
    drawInventory();
    drawFarm();
    sounds.pageChange.play();
  }

  function drawBugs() {
    bugFarmEl.innerHTML = '';
    if(currentFarmPage !== farmPagesCount -1) return;
    const bugKeys = Object.keys(purchasedBugs).filter(b => purchasedBugs[b]);
    if(bugKeys.length === 0) {
      bugFarmEl.textContent = 'B√∂cek satƒ±n alƒ±nmadƒ±.';
      bugFarmEl.style.cssText = 'font-size: 16px; color: white; display: flex; align-items: center; justify-content: center;';
      return;
    }
    bugFarmEl.style.cssText = '';
    const cols = 5;
    const rows = Math.ceil(bugKeys.length / cols);
    const cellWidth = bugFarmEl.clientWidth / cols;
    const cellHeight = bugFarmEl.clientHeight / rows;
    bugKeys.forEach((bugKey, index) => {
      const bug = document.createElement('div');
      bug.className = 'bug';
      bug.textContent = bugs[bugKey].emoji;
      bug.title = bugs[bugKey].name;
      const col = index % cols;
      const row = Math.floor(index / cols);
      const x = col * cellWidth + (cellWidth - 30)/2;
      const y = row * cellHeight + (cellHeight - 30)/2;
      bug.style.left = `${x}px`; bug.style.top = `${y}px`; bug.style.transform = 'translate(0,0)';
      bug.dataset.bugKey = bugKey;
      bug.onclick = () => showMessage(`Bu bir ${bugs[bugKey].name}!`);
      bugFarmEl.appendChild(bug);
    });
  }

  function saveGameAuto() {
    try {
      const saveData = {
        version: GAME_VERSION,
        money: money === Infinity ? 'Infinity' : money,
        level, xp, xpToNextLevel, // YENƒ∞Lƒ∞K: Seviye verilerini kaydet
        seeds, flowerSeeds, farms, currentFarmPage,
        purchasedBugs, purchasedEnhancers, ownedAnimals,
        animalHarvestReady, animalLastHarvest,
        ownedConsumables, // YENƒ∞Lƒ∞K: T√ºketilebilirleri kaydet
        marketPrices, previousMarketPrices, marketLastUpdatedDay,
        storeRented, storeRentStart, storeStock,
        customers, customerCounter
      };
      localStorage.setItem('feyza_ciftligi_save_v2', JSON.stringify(saveData));
    } catch(e) { console.error('Otomatik kaydetme ba≈üarƒ±sƒ±z:', e); }
  }

  function loadGameAuto() {
    try {
      const data = localStorage.getItem('feyza_ciftligi_save_v2');
      if(!data) return false;
      const saveData = JSON.parse(data);

      money = (saveData.money === 'Infinity' || saveData.money === Infinity) ? 100 : saveData.money || 100;
      
      // YENƒ∞Lƒ∞K: Seviye verilerini y√ºkle
      level = saveData.level || 1;
      xp = saveData.xp || 0;
      xpToNextLevel = saveData.xpToNextLevel || 100;

      seeds = saveData.seeds || { corn: 0, tomato: 0 };
      flowerSeeds = saveData.flowerSeeds || { rose: 0, tulip: 0, daisy: 0 };
      farms = saveData.farms || farms;
      currentFarmPage = saveData.currentFarmPage || 0;
      purchasedBugs = saveData.purchasedBugs || {};
      purchasedEnhancers = saveData.purchasedEnhancers || {};
      ownedAnimals = saveData.ownedAnimals || { chicken: 0, cow: 0, goat: 0 };
      animalHarvestReady = saveData.animalHarvestReady || { chicken: false, cow: false, goat: false };
      animalLastHarvest = saveData.animalLastHarvest || { chicken: 0, cow: 0, goat: 0 };
      
      // YENƒ∞Lƒ∞K: T√ºketilebilirleri y√ºkle
      ownedConsumables = saveData.ownedConsumables || { superFertilizer: 0 };

      marketPrices = saveData.marketPrices || {};
      previousMarketPrices = saveData.previousMarketPrices || {};
      marketLastUpdatedDay = saveData.marketLastUpdatedDay || null;
      storeRented = saveData.storeRented || false;
      storeRentStart = saveData.storeRentStart || 0;
      storeStock = saveData.storeStock || { danaEti: 0, hamburgerEkmegi: 0, sosis: 0, sosisliEkmegi: 0, ayran: 0, kola: 0 };
      customers = saveData.customers || [];
      customerCounter = saveData.customerCounter || 0;

      updateInfo(); drawInventory(); drawFarm(); drawBugs(); drawEnhancerList(); drawAnimals();
      return true;
    } catch(e) {
      showMessage('Y√ºkleme ba≈üarƒ±sƒ±z!');
      console.error(e);
      return false;
    }
  }

  function showMessage(text) {
    messageEl.textContent = text;
    setTimeout(() => { if (messageEl.textContent === text) messageEl.textContent = ''; }, 4000); // Mesaj g√∂sterme s√ºresi uzatƒ±ldƒ±
  }

  storeRentBtn.addEventListener('click', () => {
    if(storeRented) return;
    if(money === Infinity || money >= 1000) {
      if(money !== Infinity) money -= 1000;
      storeRented = true; storeRentStart = Date.now(); addNewCustomer(); sounds.buy.play();
      showMessage('D√ºkkan kiralandƒ±! 6 saat boyunca kullanabilirsiniz.');
      updateInfo(); drawStorePage(); saveGameAuto();
    } else { showMessage('Kiranƒ±z i√ßin paranƒ±z yetmiyor!'); }
  });

  prevPageBtn.addEventListener('click', () => changePage(false));
  nextPageBtn.addEventListener('click', () => changePage(true));

  openMarketBtn.addEventListener('click', () => { updateMarketPrices(); openMarket(); });
  closeMarketBtn.addEventListener('click', closeMarket);
  marketOverlay.addEventListener('click', () => { closeMarket(); closeMarketPrices(); });
  openMarketPricesBtn.addEventListener('click', openMarketPrices);
  closeMarketPricesBtn.addEventListener('click', closeMarketPrices);

  newGameBtn.addEventListener('click', () => {
    if(confirm('Yeni oyuna ba≈ülamak istediƒüine emin misin? T√ºm kayƒ±tlarƒ±n silinecek!')) {
      localStorage.removeItem('feyza_ciftligi_save_v2');
      localStorage.removeItem('feyza_ciftligi_farm_name');
      localStorage.removeItem("feyza_ciftligi_first_play_date");
      location.reload(); // Sayfayƒ± yeniden y√ºkleyerek sƒ±fƒ±rdan ba≈ülat
    }
  });

  function getFarmName() { return localStorage.getItem('feyza_ciftligi_farm_name'); }
  function askFarmName(forceAsk = false) {
    let name = getFarmName();
    if(name && !forceAsk) return name;
    name = prompt("Tarlanƒ±za bir isim verin! (√∂rneƒüin: Feyza'nƒ±n √áiftliƒüi)") || "Feyza'nƒ±n √áiftliƒüi";
    name = name.trim();
    if(name.length === 0) name = "Feyza'nƒ±n √áiftliƒüi";
    if(!name.toLowerCase().includes('√ßiftliƒüi')) name = `${name} √áiftliƒüi`;
    localStorage.setItem('feyza_ciftligi_farm_name', name);
    return name;
  }

  if(!getFarmName()) askFarmName();

  function periodicUpdate() {
    updateInfo(); drawFarm(); updateTimeInPlots(); updateAnimalHarvestStatus(); drawAnimals();
    if(storeRented && (Date.now() - storeRentStart >= MS_IN_6_HOURS)) {
      storeRented = false; customers = []; showMessage('D√ºkkanƒ±nƒ±zƒ±n kira s√ºresi doldu.');
    }
    if(currentFarmPage === farmPagesCount - 3) drawStorePage();
    updateMarketPrices();
    saveGameAuto();
    setTimeout(periodicUpdate, 1000);
  }

  const loaded = loadGameAuto();
  if(!loaded) {
      // Yeni oyun ba≈ülangƒ±√ß deƒüerlerini ayarla
      money = 100;
      level = 1;
      xp = 0;
      xpToNextLevel = 100;
      seeds = { corn: 5, tomato: 5, carrot: 2, wheat: 1, pepper: 1 };
      flowerSeeds = { rose: 3, tulip: 3, daisy: 3, sunflower: 1, orchid: 1 };
      ownedConsumables = { superFertilizer: 0 };
      // Diƒüer sƒ±fƒ±rlama i≈ülemleri...
      saveGameAuto();
  }
  periodicUpdate();

</script>

<script>
  if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker kayƒ±t edildi.'))
    .catch(err => console.log('Service Worker hatasƒ±:', err));
  }
</script>

</body>
</html>