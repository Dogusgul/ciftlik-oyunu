<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Çiftlik 🌾</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#388e3c" />

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e8f5e9;
    margin: 0; padding: 20px;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
  }
  #leftPanel {
    flex: none;
    width: 100%;
    max-width: 450px;
    text-align: center;
  }
  #info { font-size: 18px; margin-bottom: 8px; }
  #xpBarContainer {
    width: 100%;
    background-color: #a5d6a7;
    border-radius: 10px;
    margin-bottom: 12px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    position: relative;
    height: 18px;
  }
  #xpBar {
    width: 0%;
    height: 100%;
    background-color: #4caf50;
    border-radius: 10px;
    transition: width 0.5s ease-in-out;
  }
  #xpBarText {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    text-align: center;
    line-height: 18px;
    color: white;
    font-size: 12px;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    pointer-events: none;
  }
  #inventory {
    display: flex; justify-content: center;
    margin-bottom: 15px; gap: 10px;
    flex-wrap: wrap;
  }
  .inv-item {
    cursor: pointer; font-size: 28px; padding: 5px 10px;
    border-radius: 8px; background-color: #81c784;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    user-select: none; border: 3px solid transparent;
    transition: border-color 0.3s;
    display: flex; align-items: center; gap: 6px;
    color: white; font-weight: bold;
  }
  .inv-item.selected { border-color: #33691e; }
  .inv-count { font-size: 18px; user-select: none; color: #1b5e20; }
  #farm {
    display: grid;
    grid-template-columns: repeat(5, 80px);
    grid-gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
    min-height: 400px;
  }
  .plot {
    width: 80px; height: 80px; background: #7b4f24;
    border-radius: 8px; cursor: pointer;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-weight: bold; color: white;
    box-shadow: 0 0 4px #000000aa;
    transition: background 0.3s; font-size: 30px;
    user-select: none;
    position: relative;
    flex-shrink: 0;
  }
  .plot.planted { background: #3e7d0a; }
  .plot.grown {
    background: #4caf50; color: #003300; font-size: 40px;
  }
  button {
    padding: 10px 20px; font-size: 16px; border-radius: 6px;
    border: none; background-color: #388e3c; color: white;
    cursor: pointer; transition: background-color 0.3s;
    margin: 5px; user-select: none;
  }
  button:hover:enabled { background-color: #2e7d32; }
  button:disabled {
    background-color: #a5d6a7; cursor: not-allowed;
  }
  #controls { margin-bottom: 15px; }
  #message {
    height: 24px; font-weight: bold; color: #2e7d32;
    margin-bottom: 12px; min-height: 24px;
  }
  #questContainer {
    background: #c8e6c9;
    border: 2px solid #388e3c;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    text-align: left;
  }
  #questContainer h3 {
    margin: 0 0 10px 0;
    text-align: center;
    color: #1b5e20;
  }
  .quest-item {
    background: #e8f5e9;
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 5px;
    font-size: 14px;
    color: #333;
  }
  .quest-progress {
    font-weight: bold;
    color: #2e7d32;
  }
  .quest-reward {
    font-style: italic;
    color: #555;
    font-size: 13px;
  }
  
  #marketModal, #marketOverlay, #marketPricesModal, #storeModal, #treasureHuntModal {
    user-select: none;
  }
  #marketOverlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3); z-index: 900;
  }
  #marketModal, #marketPricesModal, #storeModal, #treasureHuntModal {
    display: none; position: fixed; top: 50%; left: 50%;
    width: 380px; background: white; border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    transform: translate(-50%, -50%);
    padding: 20px; z-index: 1000; max-height: 80vh;
    overflow-y: auto;
  }
  #marketModal h2, #marketModal h3, #marketPricesModal h2, #storeModal h2, #treasureHuntModal h2 {
    margin-top: 0; margin-bottom: 10px; text-align: center;
  }
  #marketModal .seedBtn, #marketModal .bugBtn, #marketModal .enhancerBtn, #marketModal .animalBtn, #marketModal .consumableBtn, #storeModal button, #storeModal #rentStoreBtn {
    display: flex; align-items: center; justify-content: space-between;
    background: #81c784; color: #004d00;
    margin: 6px 0; padding: 8px 12px; border-radius: 6px;
    cursor: pointer; font-weight: bold; font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.3s;
  }
  #marketModal .seedBtn:disabled, #marketModal .bugBtn:disabled, #marketModal .enhancerBtn:disabled, #marketModal .animalBtn:disabled, #marketModal .consumableBtn:disabled, #storeModal button:disabled, #storeModal #rentStoreBtn:disabled {
    background: #c8e6c9; color: #888; cursor: not-allowed;
    box-shadow: none;
  }
  #pagination {
    margin-bottom: 20px;
  }
  #pagination button {
    width: 40px; font-weight: bold; font-size: 18px; padding: 6px 0;
  }
  #bugFarm {
    width: 400px; height: 400px; background-color: #add8e6; 
    border: 5px solid #2196f3; 
    border-radius: 12px; margin: 0 auto 20px;
    position: relative;
    cursor: default;
    overflow-y: auto; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 15px; 
    padding: 15px; 
    align-content: flex-start; 
    justify-content: center;
  }
  .bug-display {
    width: 70px; 
    height: 90px; 
    background-color: #f0f8ff; 
    border: 2px solid #87ceeb; 
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .bug-display:hover:not(.on-cooldown) {
    transform: scale(1.1);
    background-color: #e0ffff; 
  }
  .bug-display.on-cooldown {
    background-color: #d3d3d3; 
    cursor: not-allowed;
    opacity: 0.7;
  }
  .bug-emoji { font-size: 36px; }
  .bug-cooldown { font-size: 12px; font-weight: bold; color: #333; margin-top: 5px; }

  #treasureHuntInfo { text-align: center; margin-bottom: 15px; font-weight: bold; }
  #treasureGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 10px;
    justify-content: center;
  }
  .treasure-cell {
    width: 65px; 
    height: 65px;
    background-color: #cd853f; 
    border: 3px solid #8b4513; 
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    transition: background-color 0.2s, transform 0.2s;
  }
  .treasure-cell:hover:not(.revealed) {
    transform: scale(1.05);
    background-color: #deb887; 
  }
  .treasure-cell.revealed {
    background-color: #f4a460; 
    cursor: default;
  }

  #animalFarm {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
    margin-bottom: 20px;
  }
  .animal {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    user-select: none;
    background: #81c784;
    border-radius: 10px;
    padding: 12px 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 320px;
    color: #004d00;
    font-weight: bold;
    font-size: 24px;
    position: relative;
  }
  .animal-emoji {
    font-size: 48px;
  }
  .animal-count {
    font-size: 18px;
    margin-top: 6px;
  }
  .harvest-status {
    font-weight: bold;
    color: #aed581;
    font-size: 14px;
    margin-top: 4px;
    user-select: none;
  }
  #storePage {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
  }
  #storeRentBtn {
    margin-bottom: 15px;
  }
  #storeMarketItems button {
    width: 100%;
  }
  #customers {
    margin-top: 20px;
  }
  .customer {
    background-color: #81c784;
    color: #004d00;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    margin: 6px 0;
    user-select: none;
  }
  .order {
    font-weight: normal;
    font-size: 14px;
  }

  @media (max-width: 650px) {
    body {
      flex-direction: column;
      padding: 8px;
      gap: 8px;
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    #leftPanel {
      width: 100%;
      max-width: 100vw;
      min-width: unset;
      padding: 8px !important;
      box-sizing: border-box;
    }
    #farm {
      grid-template-columns: repeat(3, 1fr);
      min-height: 220px;
      grid-gap: 5px;
    }
    .plot {
      width: 60px;
      height: 60px;
      font-size: 22px;
    }
    .plot.grown {
      font-size: 28px;
    }
    #bugFarm {
      width: calc(98vw - 30px); 
      height: auto; 
      min-height: 210px;
    }
    .bug-display {
      width: 60px;
      height: 80px;
    }
    .treasure-cell {
      width: 55px;
      height: 55px;
    }
    #animalFarm {
      width: 98vw;
      max-width: unset;
    }
    #pagination button {
      width: 28px;
      font-size: 14px;
      padding: 3px 0;
    }
    button {
      font-size: 14px;
      padding: 8px 6px;
    }
    #marketModal, #marketPricesModal, #storeModal, #treasureHuntModal {
      width: 98vw !important;
      min-width: unset;
      max-width: 420px;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 10px;
    }
    #questContainer {
      padding: 8px;
    }
    .quest-item {
      font-size: 13px;
    }
  }
</style>
</head>
<body>

<div id="leftPanel">
  <h1 id="farmTitle">Çiftlik 🌾</h1>
  <div id="info">Gün: 1 | Para: 100₺ | Seviye: 1 | Versiyon: 2.3.0</div>
  
  <div id="xpBarContainer">
    <div id="xpBar"></div>
    <div id="xpBarText"></div>
  </div>
  
  <div id="message"></div>
  
  <div id="questContainer">
    <h3>Görev Panosu</h3>
    <div id="questList"></div>
  </div>

  <div id="inventory"></div>

  <div id="pagination">
    <button id="prevPageBtn" disabled>←</button>
    <span id="pageIndicator">Tarla 1 / 5</span>
    <button id="nextPageBtn">→</button>
  </div>

  <div id="farm"></div>

  <div id="bugFarm" style="display:none;" title="Böcek Tarlası"></div>
  
  <div id="animalFarm" style="display:none;"></div>
  
  <div id="storePage" style="display:none;">
    <button id="storeRentBtn">Dükkan Kirala - 1000₺</button>
    <div id="storeMarketItems"></div>
    <div id="customers"></div>
  </div>

  <div id="controls">
    <button id="openMarketBtn">Market Aç</button>
    <button id="openMarketPricesBtn">Piyasa Aç</button>
    <button id="newGameBtn">Yeni Oyun</button>
  </div>
</div>

<div id="marketOverlay"></div>

<div id="marketModal">
  <h2>Market</h2>
  <h3>Tohumlar</h3>
  <div id="marketSeeds"></div>
  <h3>Tüketilebilirler</h3>
  <div id="marketConsumables"></div>
  <h3>Böcekler</h3>
  <div id="marketBugs"></div>
  <h3>Güçlendiriciler</h3>
  <div id="marketEnhancers"></div>
  <h3>Hayvanlar</h3>
  <div id="marketAnimals"></div>
  <div id="seedInventory">
    <p>Tohumlarınız:</p>
    <ul id="seedList"></ul>
    <p>Güçlendiriciler:</p>
    <ul id="enhancerList"></ul>
  </div>
  <button id="closeMarketBtn" style="margin-top:15px;">Kapat</button>
</div>

<div id="marketPricesModal">
  <h2>Piyasa</h2>
  <div id="marketPricesList"></div>
  <button id="closeMarketPricesBtn" style="margin-top:15px;">Kapat</button>
</div>

<div id="storeModal" style="display:none;">
  <h2>Dükkan Marketi</h2>
  <div id="storeMarketItems"></div>
  <button id="closeStoreBtn" style="margin-top:15px;">Kapat</button>
</div>

<div id="treasureHuntModal">
  <h2>Hazine Avı!</h2>
  <p id="treasureHuntInfo">Hazineyi bulmak için 3 hakkın var.</p>
  <div id="treasureGrid"></div>
  <button id="closeTreasureHuntBtn" style="margin-top: 15px;">Vazgeç</button>
</div>

<script>
  const sounds = {
    plant: new Audio('sounds/plant.wav'),
    harvest: new Audio('sounds/harvest.wav'),
    buy: new Audio('sounds/buy.wav'),
    pageChange: new Audio('sounds/pageChange.wav'),
    levelUp: new Audio('sounds/levelUp.wav'),
    questComplete: new Audio('sounds/questComplete.wav'),
    treasureFound: new Audio('sounds/treasure.wav')
  };

  const GAME_VERSION = '2.3.0';

  const infoEl = document.getElementById('info');
  const messageEl = document.getElementById('message');
  const inventoryEl = document.getElementById('inventory');
  const farmEl = document.getElementById('farm');
  const bugFarmEl = document.getElementById('bugFarm');
  const animalFarmEl = document.getElementById('animalFarm');
  const storePageEl = document.getElementById('storePage');
  const storeRentBtn = document.getElementById('storeRentBtn');
  const storeMarketItemsDiv = document.getElementById('storeMarketItems');
  const customersEl = document.getElementById('customers');
  const openMarketBtn = document.getElementById('openMarketBtn');
  const openMarketPricesBtn = document.getElementById('openMarketPricesBtn');
  const marketModal = document.getElementById('marketModal');
  const marketOverlay = document.getElementById('marketOverlay');
  const closeMarketBtn = document.getElementById('closeMarketBtn');
  const marketSeedsDiv = document.getElementById('marketSeeds');
  const marketConsumablesDiv = document.getElementById('marketConsumables');
  const marketBugsDiv = document.getElementById('marketBugs');
  const marketEnhancersDiv = document.getElementById('marketEnhancers');
  const marketAnimalsDiv = document.getElementById('marketAnimals');
  const seedListEl = document.getElementById('seedList');
  const enhancerListEl = document.getElementById('enhancerList');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const pageIndicator = document.getElementById('pageIndicator');
  const marketPricesModal = document.getElementById('marketPricesModal');
  const marketPricesList = document.getElementById('marketPricesList');
  const closeMarketPricesBtn = document.getElementById('closeMarketPricesBtn');
  const newGameBtn = document.getElementById('newGameBtn');
  const farmTitle = document.getElementById('farmTitle');
  const storeModal = document.getElementById('storeModal');
  const closeStoreBtn = document.getElementById('closeStoreBtn');
  const xpBar = document.getElementById('xpBar');
  const questListEl = document.getElementById('questList');
  const xpBarText = document.getElementById('xpBarText');
  const treasureHuntModal = document.getElementById('treasureHuntModal');
  const treasureGridEl = document.getElementById('treasureGrid');
  const treasureHuntInfoEl = document.getElementById('treasureHuntInfo');
  const closeTreasureHuntBtn = document.getElementById('closeTreasureHuntBtn');
  
  const farmPagesCount = 5;
  const farmSize = 5;
  const MS_IN_MINUTE = 60000;
  const MS_IN_HALF_HOUR = 1800000;
  const MS_IN_6_HOURS = 21600000;
  const MAX_ACTIVE_QUESTS = 3;
  const BUG_HUNT_COOLDOWN = 15 * 60 * 1000; 

  const crops = {
    corn:    { name: 'Mısır', growTimeMinutes: 20, price: 15, emoji: '🌽', seedPrice: 10, xp: 5 },
    tomato:  { name: 'Domates', growTimeMinutes: 16, price: 10, emoji: '🍅', seedPrice: 8, xp: 4 },
    carrot:  { name: 'Havuç', growTimeMinutes: 45, price: 12, emoji: '🥕', seedPrice: 9, xp: 8 },
    wheat:   { name: 'Buğday', growTimeMinutes: 60, price: 18, emoji: '🌾', seedPrice: 14, xp: 10 },
    pepper:  { name: 'Biber', growTimeMinutes: 25, price: 20, emoji: '🌶️', seedPrice: 15, xp: 6 }
  };

  const flowers = {
    rose:      { name: 'Gül', growTimeMinutes: 8, price: 11, emoji: '🌹', seedPrice: 9, xp: 3 },
    tulip:     { name: 'Lale', growTimeMinutes: 7, price: 10, emoji: '🌷', seedPrice: 9, xp: 3 },
    daisy:     { name: 'Papatya', growTimeMinutes: 5, price: 11, emoji: '🌼', seedPrice: 9, xp: 2 },
    sunflower: { name: 'Ayçiçeği', growTimeMinutes: 9, price: 12, emoji: '🌻', seedPrice: 15, xp: 4 },
    orchid:    { name: 'Orkide', growTimeMinutes: 10, price: 13, emoji: '💐', seedPrice: 9, xp: 4 }
  };

  const bugs = {
    spider:      { name: 'Örümcek', emoji: '🕷️', price: 1000 },
    ladybug:     { name: 'Uğur Böceği', emoji: '🐞', price: 1000 },
    ant:         { name: 'Karınca', emoji: '🐜', price: 1000 },
    beetle:      { name: 'Böcek', emoji: '🐛', price: 1100 },
    caterpillar: { name: 'Tırtıl', emoji: '🐛', price: 1200 },
    centipede:   { name: 'Kırkayak', emoji: '🐛', price: 1300 },
    mantis:      { name: 'Sinek Kapan', emoji: '🦗', price: 1400 }
  };

  const enhancers = {
    fastHarvest:   { name: 'Hızlı Hasat Güçlendirici', description: 'Ekinlerin olgunlaşma süresi %20 azalır.', price: 5000 },
    fertileSoil:   { name: 'Verimli Toprak', description: 'Hasattan elde edilen para %20 artar.', price: 9000 },
    richSeed:      { name: 'Zengin Tohum', description: 'Hasatta %30 ihtimalle +1 ek ürün verir.', price: 12000 },
    freshKeeper:   { name: 'Tazelik Koruyucu', description: 'Bozulma süresini 48 saate çıkarır.', price: 8000 }
  };

  const animals = {
    chicken: { name: 'Tavuk', emoji: '🐔', buyPrice: 300, productPrice: 25, xp: 15 },
    cow:     { name: 'İnek', emoji: '🐄', buyPrice: 500, productPrice: 50, xp: 30 },
    goat:    { name: 'Keçi', emoji: '🐐', buyPrice: 1200, productPrice: 120, xp: 50 }
  };

  const consumables = {
    superFertilizer: { name: 'Süper Gübre', emoji: '🧪', price: 250, description: 'Ektiğiniz bir bitkinin anında büyümesini sağlar.' }
  };

  const storeProducts = {
    danaEti: { name: 'Dana Eti', buyPrice: 10 },
    hamburgerEkmegi: { name: 'Hamburger Ekmeği', buyPrice: 10 },
    sosis: { name: 'Sosis', buyPrice: 5 },
    sosisliEkmegi: { name: 'Sosisli Ekmeği', buyPrice: 2 },
    ayran: { name: 'Ayran', buyPrice: 5, sellPrice: 10 },
    kola: { name: 'Kola', buyPrice: 8, sellPrice: 12 }
  };
  
  const allQuests = [
    { id: 1, text: '25 adet Mısır hasat et', type: 'harvest', target: 'corn', amount: 25, reward: { money: 200, xp: 50 } },
    { id: 2, text: '15 adet Domates hasat et', type: 'harvest', target: 'tomato', amount: 15, reward: { money: 150, xp: 40 } },
    { id: 3, text: '1 adet Tavuk satın al', type: 'buy_animal', target: 'chicken', amount: 1, reward: { money: 100, xp: 30 } },
    { id: 4, text: '1 adet İnek satın al', type: 'buy_animal', target: 'cow', amount: 1, reward: { money: 250, xp: 60 } },
    { id: 5, text: 'Toplam 1000₺ kazan', type: 'earn_money', target: 'money', amount: 1000, reward: { money: 100, xp: 100 } },
    { id: 6, text: '10 adet Gül hasat et', type: 'harvest', target: 'rose', amount: 10, reward: { money: 80, xp: 25 } },
    { id: 7, text: '5 adet Biber hasat et', type: 'harvest', target: 'pepper', amount: 5, reward: { money: 120, xp: 35 } },
    { id: 8, text: '2 adet Keçi satın al', type: 'buy_animal', target: 'goat', amount: 2, reward: { money: 500, xp: 150 } },
    { id: 9, text: 'Dükkandan 5 sipariş teslim et', type: 'deliver_order', target: 'any', amount: 5, reward: { money: 300, xp: 120 } }
  ];

  let money = 100;
  let level = 1;
  let xp = 0;
  let xpToNextLevel = 100;

  let seeds = { corn: 5, tomato: 5, carrot: 2, wheat: 1, pepper: 1 };
  let flowerSeeds = { rose: 3, tulip: 3, daisy: 3, sunflower: 1, orchid: 1 };
  let purchasedBugs = {};
  let purchasedEnhancers = {};
  let ownedAnimals = { chicken: 0, cow: 0, goat: 0 };
  let animalHarvestReady = { chicken: false, cow: false, goat: false };
  let animalLastHarvest = { chicken: 0, cow: 0, goat: 0 };

  let ownedConsumables = {
    superFertilizer: 0
  };

  let playerQuests = [];
  let bugLastPlayed = {};
  
  let storeRented = false;
  let storeRentStart = 0;
  let storeStock = {
    danaEti: 0, hamburgerEkmegi: 0, sosis: 0, sosisliEkmegi: 0, ayran: 0, kola: 0
  };

  let customers = [];
  let customerCounter = 0;

  let farms = [];
  // Initialize farms with empty plots for all pages
  for(let i=0; i<farmPagesCount; i++) { // Changed to farmPagesCount to include the last page
    let pageFarm = [];
    for(let j=0; j<farmSize*farmSize; j++) {
      pageFarm.push({ state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 });
    }
    farms.push(pageFarm);
  }

  let currentFarmPage = 0;
  let selectedItem = null;
  let selectedItemType = 'seed';

  const allProducts = {...crops, ...flowers};

  let marketPrices = {};
  let previousMarketPrices = {};
  let marketLastUpdatedDay = null;

  let treasureGame = {
    active: false,
    bugKey: null,
    triesLeft: 3,
    treasureLocation: -1
  };

  function getCurrentGameDay() {
    const now = new Date();
    return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
  }
  
  function addXp(amount) {
    if (isNaN(amount)) return;
    xp += amount;
    if (xp >= xpToNextLevel) {
      level++;
      xp = xp - xpToNextLevel;
      xpToNextLevel = Math.floor(xpToNextLevel * 1.5);
      showMessage(`🎉 Seviye atladın! Yeni seviyen: ${level} 🎉`);
      try { sounds.levelUp.play(); } catch(e) {}
    }
    updateInfo();
  }
  
  function addMoney(amount) {
    if (isNaN(amount)) return;
    money += amount;
    updateQuestProgress('earn_money', 'money', amount);
  }
  
  function initQuests() {
    while (playerQuests.length < MAX_ACTIVE_QUESTS) {
      addRandomQuest();
    }
    drawQuests();
  }

  function addRandomQuest() {
    const availableQuests = allQuests.filter(q => !playerQuests.some(pq => pq.id === q.id));
    if (availableQuests.length === 0) return;

    const randomQuest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
    playerQuests.push({ ...randomQuest, progress: 0 });
  }
  
  function updateQuestProgress(type, target, amount) {
    let questCompletedThisUpdate = false;
    playerQuests.forEach(quest => {
        if (!quest.isComplete && quest.type === type && (quest.target === 'any' || quest.target === target)) {
             quest.progress += amount;
        }

        if (!quest.isComplete && quest.progress >= quest.amount) {
            quest.isComplete = true; 
            completeQuest(quest);
            questCompletedThisUpdate = true;
        }
    });

    if (questCompletedThisUpdate) {
        playerQuests = playerQuests.filter(q => !q.isComplete);
        while (playerQuests.length < MAX_ACTIVE_QUESTS) {
            addRandomQuest();
        }
    }
    drawQuests();
  }

  function completeQuest(quest) {
    addMoney(quest.reward.money);
    addXp(quest.reward.xp);
    showMessage(`Görev Tamamlandı: ${quest.text} (+${quest.reward.money}₺, +${quest.reward.xp} XP)`);
    try { sounds.questComplete.play(); } catch(e) {}
  }

  function drawQuests() {
    questListEl.innerHTML = '';
    if (playerQuests.length === 0) {
        questListEl.innerHTML = '<p>Aktif görevin yok.</p>';
        return;
    }

    playerQuests.forEach(quest => {
        const questDiv = document.createElement('div');
        questDiv.className = 'quest-item';
        const currentProgress = Math.min(Math.floor(quest.progress), quest.amount);
        const progressText = `<span class="quest-progress">(${currentProgress}/${quest.amount})</span>`;
        const rewardText = `<div class="quest-reward">Ödül: ${quest.reward.money}₺, ${quest.reward.xp} XP</div>`;
        
        questDiv.innerHTML = `${quest.text} ${progressText}${rewardText}`;
        questListEl.appendChild(questDiv);
    });
  }

  function startTreasureHunt(bugKey) {
    const now = Date.now();
    const lastPlayed = bugLastPlayed[bugKey] || 0;

    if (now - lastPlayed < BUG_HUNT_COOLDOWN) {
      const remainingMs = BUG_HUNT_COOLDOWN - (now - lastPlayed);
      const remainingMin = Math.ceil(remainingMs / 60000);
      showMessage(`${bugs[bugKey].name} ile hazine avına çıkmak için ${remainingMin} dakika beklemelisin.`);
      return;
    }

    treasureGame = {
      active: true,
      bugKey: bugKey,
      triesLeft: 3,
      treasureLocation: Math.floor(Math.random() * 16)
    };

    setupTreasureGrid();
    treasureHuntModal.style.display = 'block';
    marketOverlay.style.display = 'block';
  }

  function setupTreasureGrid() {
    treasureGridEl.innerHTML = '';
    treasureHuntInfoEl.textContent = `Hazineyi bulmak için ${treasureGame.triesLeft} hakkın var.`;

    for (let i = 0; i < 16; i++) {
      const cell = document.createElement('div');
      cell.className = 'treasure-cell';
      cell.dataset.index = i;
      cell.onclick = () => handleTreasureCellClick(cell);
      treasureGridEl.appendChild(cell);
    }
  }

  function handleTreasureCellClick(cell) {
    if (!treasureGame.active || cell.classList.contains('revealed')) return;

    treasureGame.triesLeft--;
    cell.classList.add('revealed');

    const index = parseInt(cell.dataset.index);
    if (index === treasureGame.treasureLocation) {
      cell.textContent = '💰';
      endTreasureHunt(true);
    } else {
      cell.textContent = '🧱';
      treasureHuntInfoEl.textContent = `Hazineyi bulmak için ${treasureGame.triesLeft} hakkın var.`;
      if (treasureGame.triesLeft <= 0) {
        endTreasureHunt(false);
      }
    }
  }

  function endTreasureHunt(isWin) {
    treasureGame.active = false;
    bugLastPlayed[treasureGame.bugKey] = Date.now(); 

    if (isWin) {
      const reward = Math.floor(Math.random() * (250 - 150 + 1)) + 150;
      addMoney(reward);
      showMessage(`Tebrikler! ${reward}₺ buldun!`);
      try { sounds.treasureFound.play(); } catch(e) {}
    } else {
      const allCells = treasureGridEl.querySelectorAll('.treasure-cell');
      if (allCells[treasureGame.treasureLocation]) {
         allCells[treasureGame.treasureLocation].textContent = '💰';
         allCells[treasureGame.treasureLocation].style.backgroundColor = '#ffcccb';
      }
      showMessage('Maalesef, hazineyi bulamadın! Başka sefere.');
    }

    setTimeout(() => {
      treasureHuntModal.style.display = 'none';
      marketOverlay.style.display = 'none';
      if (currentFarmPage === 4) drawBugs();
      saveGameAuto();
    }, isWin ? 2000: 3000); // Kaybedince biraz daha uzun göster
  }

  closeTreasureHuntBtn.addEventListener('click', () => {
      treasureHuntModal.style.display = 'none';
      marketOverlay.style.display = 'none';
      treasureGame.active = false;
  });

  function updateMarketPrices() {
    const currentDay = getCurrentGameDay();
    if(currentDay === marketLastUpdatedDay) return;
    marketLastUpdatedDay = currentDay;
    previousMarketPrices = {...marketPrices};
    Object.keys(crops).forEach(key => {
      let basePrice = crops[key].price;
      let change = (Math.random() * 0.6) - 0.10;
      if(Math.random() < 0.10) change = -0.10;
      else if(Math.random() < 0.05) change = 1.00;
      marketPrices[key] = Math.max(1, Math.floor(basePrice * (1 + change)));
    });
    Object.keys(flowers).forEach(key => {
      marketPrices[key] = Math.floor(Math.random() * (8 - 4 + 1)) + 4;
    });
  }

  function profitEmoji(todayPrice, yesterdayPrice) {
    if(yesterdayPrice === undefined) return '➖';
    if(todayPrice > yesterdayPrice) return '⬆️';
    if(todayPrice < yesterdayPrice) return '⬇️';
    return '➖';
  }

  function openMarketPrices() {
    renderMarketPrices();
    marketPricesModal.style.display = 'block';
    marketOverlay.style.display = 'block';
  }

  function closeMarketPrices() {
    marketPricesModal.style.display = 'none';
    marketOverlay.style.display = 'none';
  }

  function renderMarketPrices() {
    marketPricesList.innerHTML = '';
    for(const key in marketPrices) {
      const p = document.createElement('p');
      const product = allProducts[key];
      const emoji = profitEmoji(marketPrices[key], previousMarketPrices[key]);
      const seedPrice = product.seedPrice !== undefined ? product.seedPrice : product.price;
      p.innerHTML = `${product.emoji} ${product.name}: ${marketPrices[key]}₺ (Normal: ${seedPrice}₺) <span class="profit-emoji">${emoji}</span>`;
      marketPricesList.appendChild(p);
    }
  }

  function drawInventory() {
    inventoryEl.innerHTML = '';
    const sourceSeeds = currentFarmPage === 1 ? flowerSeeds : seeds;
    const sourceCrops = currentFarmPage === 1 ? flowers : crops;

    // Only show seeds for the current farm type
    if (currentFarmPage === 0 || currentFarmPage === 1) {
        for(const key in sourceSeeds) {
            if(sourceSeeds[key] > 0) {
                const btn = document.createElement('div');
                btn.className = 'inv-item';
                if(selectedItem === key && selectedItemType === 'seed') btn.classList.add('selected');
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = sourceCrops[key].emoji;
                const countSpan = document.createElement('span');
                countSpan.className = 'inv-count';
                countSpan.textContent = sourceSeeds[key];
                btn.title = `${sourceCrops[key].name} (${sourceSeeds[key]} adet)`;
                btn.onclick = () => {
                    selectedItem = key;
                    selectedItemType = 'seed';
                    drawInventory();
                    showMessage(`${sourceCrops[key].name} seçildi.`);
                };
                btn.appendChild(emojiSpan);
                btn.appendChild(countSpan);
                inventoryEl.appendChild(btn);
            }
        }
    }
    
    // Always show consumables
    for (const key in ownedConsumables) {
        if (ownedConsumables[key] > 0) {
            const itemData = consumables[key];
            const btn = document.createElement('div');
            btn.className = 'inv-item';
            if (selectedItem === key && selectedItemType === 'consumable') btn.classList.add('selected');
            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = itemData.emoji;
            const countSpan = document.createElement('span');
            countSpan.className = 'inv-count';
            countSpan.textContent = ownedConsumables[key];
            btn.title = `${itemData.name} (${ownedConsumables[key]} adet)`;
            btn.onclick = () => {
                selectedItem = key;
                selectedItemType = 'consumable';
                drawInventory();
                showMessage(`${itemData.name} seçildi.`);
            };
            btn.appendChild(emojiSpan);
            btn.appendChild(countSpan);
            inventoryEl.appendChild(btn);
        }
    }
  }

  function drawEnhancerList() {
    enhancerListEl.innerHTML = '';
    for(const key in purchasedEnhancers) {
      if(purchasedEnhancers[key]) {
        const li = document.createElement('li');
        li.textContent = enhancers[key].name;
        enhancerListEl.appendChild(li);
      }
    }
  }

  function drawFarm() {
    farmEl.style.display = 'none';
    bugFarmEl.style.display = 'none';
    animalFarmEl.style.display = 'none';
    storePageEl.style.display = 'none';
    
    const pageConfig = [
        { type: 'farm', displayEl: farmEl, drawFunc: drawFarmPlots, title: `Tarla 1` },
        { type: 'farm', displayEl: farmEl, drawFunc: drawFarmPlots, title: `Tarla 2 (Çiçek)` },
        { type: 'store', displayEl: storePageEl, drawFunc: drawStorePage, title: 'Dükkan' },
        { type: 'animal', displayEl: animalFarmEl, drawFunc: drawAnimals, title: 'Hayvan Çiftliği' },
        { type: 'bug', displayEl: bugFarmEl, drawFunc: drawBugs, title: 'Böcek Tarlası' }
    ];

    const config = pageConfig[currentFarmPage];
    // Special handling for farm pages (0 and 1) to use grid display.
    // Other pages use flex.
    if (config.type === 'farm') {
        config.displayEl.style.display = 'grid';
    } else {
        config.displayEl.style.display = 'flex';
    }
    config.drawFunc();
    pageIndicator.textContent = `${config.title} / ${farmPagesCount}`;
    
    prevPageBtn.disabled = currentFarmPage === 0;
    nextPageBtn.disabled = currentFarmPage === farmPagesCount - 1;
  }
  
  function drawFarmPlots() {
    farmEl.innerHTML = '';
    const farm = farms[currentFarmPage];
    farm.forEach((plot, i) => {
      const plotEl = document.createElement('div');
      plotEl.classList.add('plot');
      
      // Determine background color based on plot state and page type
      if(plot.state === 'empty') {
        plotEl.style.backgroundColor = currentFarmPage === 1 ? '#7a4f8a' : '#7b4f24';
      } else {
        const isReady = isPlotReady(plot);
        const isSpoiled = isPlotSpoiled(plot);
        
        if (isSpoiled) {
            plotEl.style.backgroundColor = '#616161'; // Darker for spoiled
            plotEl.innerHTML = '<span style="font-size:20px;">🤢</span>'; // Spoiled emoji
            plotEl.classList.add('spoiled'); // Add spoiled class if you want to style further
        } else {
            plotEl.classList.add(isReady ? 'grown' : 'planted');
            const emoji = (currentFarmPage === 1 ? flowers : crops)[plot.cropType]?.emoji || '';
            
            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = emoji;
            emojiSpan.style.fontSize = isReady ? '40px' : '30px';

            const timeSpan = document.createElement('span');
            timeSpan.style.fontSize = '14px';
            timeSpan.style.fontWeight = 'bold';
            timeSpan.dataset.plotIndex = i;

            plotEl.appendChild(emojiSpan);
            plotEl.appendChild(timeSpan);
        }
      }
      plotEl.onclick = () => handlePlotClick(i, plot);
      farmEl.appendChild(plotEl);
    });
    updateTimeInPlots();
  }
  
  function handlePlotClick(index, plot) {
    if (selectedItemType === 'consumable' && selectedItem === 'superFertilizer') {
        if (plot.state === 'planted' && !isPlotReady(plot) && !isPlotSpoiled(plot)) {
            useSuperFertilizer(index);
        } else {
            showMessage('Süper Gübre sadece ekili ve büyümemiş bitkilerde kullanılır!');
        }
        return;
    }

    if(plot.state === 'empty') {
        if (selectedItemType === 'seed' && selectedItem) {
            plantCrop(index, selectedItem);
        } else {
            showMessage('Lütfen envanterden bir tohum seçin!');
        }
    } else {
      if(isPlotReady(plot)) {
        harvestCrop(index);
      } else if(isPlotSpoiled(plot)) {
        showMessage('Bu ürün bozuldu, hasat edemezsin!');
        // Allow clearing spoiled plots by clicking on them
        farms[currentFarmPage][index] = { state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 };
        showMessage('Bozulmuş ürün temizlendi.');
        drawFarm();
        saveGameAuto();
      } else {
        showMessage('Ekin büyüyor, sabırlı ol!');
      }
    }
  }

  function drawAnimals() {
    animalFarmEl.innerHTML = '';
    Object.keys(animals).forEach(key => {
      const animal = animals[key];
      const count = ownedAnimals[key];
      const div = document.createElement('div');
      div.className = 'animal';
      div.title = animal.name;
      const emojiSpan = document.createElement('span');
      emojiSpan.className = 'animal-emoji';
      emojiSpan.textContent = animal.emoji;
      const countSpan = document.createElement('span');
      countSpan.className = 'animal-count';
      countSpan.textContent = `Adet: ${count}`;
      const harvestSpan = document.createElement('span');
      harvestSpan.className = 'harvest-status';

      if(count > 0) {
        if(animalHarvestReady[key]) {
          harvestSpan.textContent = 'Hasat hazır!';
        } else {
          const now = Date.now();
          const elapsed = now - (animalLastHarvest[key] || 0);
          const remaining = MS_IN_HALF_HOUR - elapsed;
          if(remaining > 0) {
            const min = Math.floor(remaining / 60000);
            const sec = Math.floor((remaining % 60000) / 1000);
            harvestSpan.textContent = `Hasat: ${min}:${sec.toString().padStart(2,'0')}`;
          } else {
            harvestSpan.textContent = 'Hasat hazır!';
          }
        }
      }
      div.appendChild(emojiSpan);
      div.appendChild(countSpan);
      div.appendChild(harvestSpan);

      div.onclick = () => {
        if(count === 0) {
          showMessage(`${animal.name} satın alınmamış!`);
          return;
        }
        if(animalHarvestReady[key]) {
          const totalIncome = count * animal.productPrice;
          addMoney(totalIncome);
          animalHarvestReady[key] = false;
          animalLastHarvest[key] = Date.now();
          addXp(animal.xp * count);
          showMessage(`${animal.name} hasat edildi! +${totalIncome}₺ ve ${animal.xp * count} XP!`);
          updateInfo();
          drawAnimals();
          saveGameAuto();
          try { sounds.harvest.play(); } catch(e) {}
        } else {
          showMessage(`${animal.name} için hasat hazır değil.`);
        }
      };
      animalFarmEl.appendChild(div);
    });
  }

  function drawStorePage() {
    storeMarketItemsDiv.innerHTML = '';
    customersEl.innerHTML = '';
    storeRentBtn.textContent = storeRented
      ? `Dükkan kiralandı! Kira bitiş: ${new Date(storeRentStart + MS_IN_6_HOURS).toLocaleTimeString()}`
      : 'Dükkan Kirala - 1000₺';
    storeRentBtn.disabled = storeRented || (money < 1000);
    let stockHtml = '<b>Dükkan Stoğu:</b><br>';
    for (const key in storeStock) stockHtml += `${storeProducts[key].name}: ${storeStock[key]}<br>`;
    storeMarketItemsDiv.innerHTML = stockHtml;
    for (const key in storeProducts) {
      const product = storeProducts[key];
      const btn = document.createElement('button');
      btn.textContent = `Satın Al: ${product.name} - ${product.buyPrice}₺`;
      btn.disabled = (money < product.buyPrice) || !storeRented;
      btn.onclick = () => buyStoreItem(key);
      storeMarketItemsDiv.appendChild(btn);
    }
    if(storeRented && customers.length > 0) {
      customers.forEach((customer, index) => {
        const custDiv = document.createElement('div');
        custDiv.className = 'customer';
        const orderNames = customer.orders.map(o => {
            if (o === 'hamburger') return 'Hamburger';
            if (o === 'sosisli') return 'Sosisli';
            return storeProducts[o] ? storeProducts[o].name : o;
        }).join(' ve ');
        custDiv.innerHTML = `Müşteri ${orderNames} istiyor.`;
        custDiv.onclick = () => deliverOrder(index);
        customersEl.appendChild(custDiv);
      });
    } else if (storeRented && customers.length === 0) {
        customersEl.innerHTML = '<p>Bekleyen müşteri yok.</p>';
    } else if (!storeRented) {
        customersEl.innerHTML = '<p>Dükkanı kiralayınca müşteriler gelmeye başlayacak!</p>';
    }
  }

  function buyStoreItem(key) {
    if(!storeRented) {
      showMessage('Önce dükkanı kiralamalısın!');
      return;
    }
    const product = storeProducts[key];
    if(money >= product.buyPrice) {
      money -= product.buyPrice;
      storeStock[key]++;
      try { sounds.buy.play(); } catch(e) {}
      showMessage(`${product.name} satın alındı.`);
      updateInfo();
      drawStorePage();
      saveGameAuto();
    } else {
      showMessage('Paran yetmiyor!');
    }
  }

  function deliverOrder(customerIndex) {
    const customer = customers[customerIndex];
    if(!customer) return;
    
    let canDeliver = customer.orders.every(item => {
      if(item === 'hamburger') return storeStock.danaEti >= 1 && storeStock.hamburgerEkmegi >= 1;
      if(item === 'sosisli') return storeStock.sosis >= 1 && storeStock.sosisliEkmegi >= 1;
      return storeStock[item] >= 1;
    });

    if(!canDeliver) {
      showMessage('Siparişi teslim etmek için yeterli malzemen yok!');
      return;
    }

    let totalGain = 0, totalXp = 0;
    customer.orders.forEach(item => {
      if(item === 'hamburger') {
        storeStock.danaEti--; storeStock.hamburgerEkmegi--;
        totalGain += 30; totalXp += 20;
      } else if(item === 'sosisli') {
        storeStock.sosis--; storeStock.sosisliEkmegi--;
        totalGain += 12; totalXp += 10;
      } else {
        storeStock[item]--;
        totalGain += storeProducts[item].sellPrice; totalXp += 5;
      }
    });

    addMoney(totalGain);
    addXp(totalXp);
    updateQuestProgress('deliver_order', 'any', 1);

    showMessage(`Sipariş teslim edildi! +${totalGain}₺ ve ${totalXp} XP!`);
    customers.splice(customerIndex, 1);
    // Only add a new customer if the store is still rented
    if(storeRented) addNewCustomer(); 
    
    updateInfo();
    drawStorePage();
    saveGameAuto();
  }

  function addNewCustomer() {
    // Only add a new customer if there are less than 3 active customers and the store is rented
    if (customers.length >= 3 || !storeRented) return;

    const possibleOrders = ['hamburger', 'kola', 'ayran', 'sosisli'];
    const orderCount = Math.floor(Math.random() * 2) + 1;
    let orders = [];
    while (orders.length < orderCount) {
      const item = possibleOrders[Math.floor(Math.random() * possibleOrders.length)];
      if(!orders.includes(item)) orders.push(item);
    }
    customers.push({ id: ++customerCounter, orders });
  }

  function updateTimeInPlots() {
    const plotTimeSpans = farmEl.querySelectorAll('span[data-plot-index]');
    const now = Date.now();
    plotTimeSpans.forEach(span => {
      const i = parseInt(span.dataset.plotIndex);
      const plot = farms[currentFarmPage]?.[i];
      if(!plot || plot.state !== 'planted') {
        span.textContent = ''; return;
      }
      const growTimeMs = getEffectiveGrowTime(plot) * MS_IN_MINUTE;
      const remainingMs = (plot.plantedAt + growTimeMs) - now;
      
      if(isPlotSpoiled(plot)) {
        span.textContent = 'BOZULDU!'; span.style.color = '#b71c1c';
      } else if(remainingMs <= 0) {
        span.textContent = 'Hazır!'; span.style.color = '#aed581';
      } else {
        const remMin = Math.floor(remainingMs / 60000);
        const remS = Math.floor((remainingMs % 60000) / 1000);
        span.textContent = `${remMin}:${remS.toString().padStart(2,'0')}`;
        span.style.color = '#c5e1a5';
      }
    });
  }

  function updateAnimalHarvestStatus() {
    const now = Date.now();
    Object.keys(animals).forEach(key => {
      if(ownedAnimals[key] > 0) {
        animalHarvestReady[key] = (now - (animalLastHarvest[key] || 0)) >= MS_IN_HALF_HOUR;
      }
    });
  }

  function isPlotReady(plot) {
    if(plot.state !== 'planted' || !plot.plantedAt) return false;
    return (Date.now() - plot.plantedAt) >= getEffectiveGrowTime(plot) * MS_IN_MINUTE;
  }

  function getEffectiveGrowTime(plot) {
    let t = plot.growTimeMinutes;
    if(purchasedEnhancers.fastHarvest) t *= 0.8;
    return t;
  }

  function isPlotSpoiled(plot) {
    if(plot.state !== 'planted' || !plot.plantedAt) return false;
    const maxHours = purchasedEnhancers.freshKeeper ? 48 : 24;
    // Spoilage time is after the growth time plus the spoilage duration.
    // So, total time till spoiled = growTimeMinutes + maxHours * 60 minutes
    return (Date.now() - plot.plantedAt) >= (getEffectiveGrowTime(plot) + maxHours * 60) * MS_IN_MINUTE;
  }

  function plantCrop(index, cropKey) {
    const isFlowerPage = currentFarmPage === 1;
    const cropData = isFlowerPage ? flowers[cropKey] : crops[cropKey];
    const sourceSeeds = isFlowerPage ? flowerSeeds : seeds;
    
    if(!cropData) {
        showMessage('Bu tohum bu tarlaya ekilemez!');
        return;
    }
    if(sourceSeeds[cropKey] <= 0) {
        showMessage('Bu tohumdan stokta kalmadı!');
        return;
    }
    
    farms[currentFarmPage][index] = {
      state: 'planted', cropType: cropKey, plantedAt: Date.now(), growTimeMinutes: cropData.growTimeMinutes
    };
    sourceSeeds[cropKey]--;
    try { sounds.plant.play(); } catch(e) {}
    showMessage(`${cropData.name} ektin!`);
    updateInfo(); drawInventory(); drawFarm(); saveGameAuto();
  }

  function useSuperFertilizer(index) {
    if (ownedConsumables.superFertilizer <= 0) {
        showMessage('Süper Gübreniz yok!');
        return;
    }
    
    let plot = farms[currentFarmPage][index];
    if (plot.state !== 'planted' || isPlotReady(plot) || isPlotSpoiled(plot)) {
        showMessage('Süper Gübre sadece ekili ve büyümemiş bitkilerde kullanılır!');
        return;
    }

    // Set plantedAt to a time in the past that makes it immediately ready
    // Ensure it's not set *too* far in the past to prevent immediate spoilage
    const effectiveGrowTimeMs = getEffectiveGrowTime(plot) * MS_IN_MINUTE;
    plot.plantedAt = Date.now() - effectiveGrowTimeMs - 1000; // 1 second before ready
    ownedConsumables.superFertilizer--;
    
    showMessage(`${allProducts[plot.cropType].name} anında büyüdü!`);
    try { sounds.plant.play(); } catch(e) {}
    updateInfo(); drawInventory(); drawFarm(); saveGameAuto();
  }

  function harvestCrop(index) {
    let plot = farms[currentFarmPage][index];
    const cropKey = plot.cropType;
    let cropData = currentFarmPage === 1 ? flowers[cropKey] : crops[cropKey];

    if(isPlotSpoiled(plot)) {
      farms[currentFarmPage][index] = { state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 };
      showMessage(`${cropData.name} bozulmuş, hasat edilemedi! 😢`);
      drawFarm(); saveGameAuto();
      return;
    }
    
    if (!isPlotReady(plot)) {
        showMessage('Ekin henüz hasat için hazır değil!');
        return;
    }

    let gain = (currentFarmPage === 1) ? Math.max(cropData.price, cropData.seedPrice + 20)
                                      : (marketPrices[cropKey] || cropData.price);
    if(purchasedEnhancers.fertileSoil && currentFarmPage !== 1) gain *= 1.2;
    
    let extra = (purchasedEnhancers.richSeed && Math.random() < 0.3) ? 1 : 0;
    let totalGain = Math.floor(gain * (1 + extra));
    
    addMoney(totalGain);
    addXp(cropData.xp * (1 + extra));
    updateQuestProgress('harvest', cropKey, (1 + extra));

    farms[currentFarmPage][index] = { state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 };
    try { sounds.harvest.play(); } catch(e) {}
    showMessage(`${cropData.name} hasat edildi! +${totalGain}₺`);
    updateInfo(); drawFarm(); saveGameAuto();
  }

  function openMarket() {
    marketModal.style.display = 'block';
    marketOverlay.style.display = 'block';
    renderMarketSeeds();
    renderMarketConsumables();
    renderMarketBugs();
    renderMarketEnhancers();
    renderMarketAnimals();
    updateSeedInventory();
    drawEnhancerList();
  }

  function closeMarket() {
    marketModal.style.display = 'none';
    marketOverlay.style.display = 'none';
  }

  function renderMarketSeeds() {
    marketSeedsDiv.innerHTML = '';
    const allSeedTypes = {...crops, ...flowers};
    Object.keys(allSeedTypes).forEach(key => {
        const crop = allSeedTypes[key];
        const btn = document.createElement('button');
        btn.className = 'seedBtn';
        btn.textContent = `${crop.emoji} ${crop.name} Tohumu - ${crop.seedPrice}₺`;
        btn.disabled = money < crop.seedPrice;
        btn.onclick = () => (crops[key] ? buySeed(key) : buySeedFlower(key)); // Differentiate based on crop or flower
        marketSeedsDiv.appendChild(btn);
    });
  }

  function renderMarketConsumables() {
    marketConsumablesDiv.innerHTML = '';
    Object.keys(consumables).forEach(key => {
      const item = consumables[key];
      const btn = document.createElement('button');
      btn.className = 'consumableBtn';
      btn.textContent = `${item.emoji} ${item.name} - ${item.price}₺`;
      btn.disabled = money < item.price;
      btn.title = item.description;
      btn.onclick = () => buyConsumable(key);
      marketConsumablesDiv.appendChild(btn);
    });
  }
  
  function buyConsumable(key) {
    const item = consumables[key];
    if (money >= item.price) {
        money -= item.price;
        ownedConsumables[key]++;
        try { sounds.buy.play(); } catch(e) {}
        showMessage(`${item.name} satın aldın.`);
        updateInfo(); drawInventory(); renderMarketConsumables(); saveGameAuto();
    } else {
        showMessage('Paran yetmiyor!');
    }
  }

  function buySeed(seedKey) {
    const crop = crops[seedKey];
    if(money >= crop.seedPrice) {
      money -= crop.seedPrice;
      seeds[seedKey]++;
      try { sounds.buy.play(); } catch(e) {}
      updateInfo(); drawInventory(); renderMarketSeeds(); saveGameAuto();
    } else { showMessage('Paran yetmiyor!'); }
  }
  
  function buySeedFlower(seedKey) {
    const flower = flowers[seedKey];
    if(money >= flower.seedPrice) {
      money -= flower.seedPrice;
      flowerSeeds[seedKey]++;
      try { sounds.buy.play(); } catch(e) {}
      updateInfo(); drawInventory(); renderMarketSeeds(); saveGameAuto();
    } else { showMessage('Paran yetmiyor!'); }
  }

  function renderMarketBugs() {
    marketBugsDiv.innerHTML = '';
    for(const key in bugs) {
      const btn = document.createElement('button');
      btn.classList.add('bugBtn');
      btn.textContent = `${bugs[key].emoji} ${bugs[key].name} - ${bugs[key].price}₺`;
      btn.disabled = purchasedBugs[key] || (money < bugs[key].price);
      btn.onclick = () => buyBug(key);
      marketBugsDiv.appendChild(btn);
    }
  }

  function buyBug(bugKey) {
    if(purchasedBugs[bugKey]) { showMessage('Bu böceği zaten satın aldın!'); return; }
    if(money >= bugs[bugKey].price) {
      money -= bugs[bugKey].price;
      purchasedBugs[bugKey] = true;
      bugLastPlayed[bugKey] = 0; // Newly purchased bugs have no cooldown initially
      try { sounds.buy.play(); } catch(e) {}
      showMessage(`${bugs[bugKey].name} satın alındı!`);
      updateInfo(); renderMarketBugs(); drawBugs(); saveGameAuto();
    } else { showMessage('Paran yetmiyor!'); }
  }

  function renderMarketEnhancers() {
    marketEnhancersDiv.innerHTML = '';
    for(const key in enhancers) {
      const btn = document.createElement('button');
      btn.classList.add('enhancerBtn');
      btn.textContent = `${enhancers[key].name} - ${enhancers[key].price}₺`;
      btn.disabled = purchasedEnhancers[key] || (money < enhancers[key].price);
      btn.title = enhancers[key].description;
      btn.onclick = () => buyEnhancer(key);
      marketEnhancersDiv.appendChild(btn);
    }
  }

  function buyEnhancer(key) {
    if(purchasedEnhancers[key]) { showMessage('Bu güçlendiriciyi zaten satın aldın!'); return; }
    if(money >= enhancers[key].price) {
      money -= enhancers[key].price;
      purchasedEnhancers[key] = true;
      try { sounds.buy.play(); } catch(e) {}
      showMessage(`${enhancers[key].name} satın alındı!`);
      updateInfo(); renderMarketEnhancers(); drawEnhancerList(); saveGameAuto();
    } else { showMessage('Paran yetmiyor!'); }
  }
  
  function renderMarketAnimals() {
    marketAnimalsDiv.innerHTML = '';
    Object.keys(animals).forEach(key => {
      const animal = animals[key];
      const btn = document.createElement('button');
      btn.className = 'animalBtn';
      btn.textContent = `${animal.emoji} ${animal.name} - ${animal.buyPrice}₺`;
      btn.disabled = money < animal.buyPrice;
      btn.onclick = () => buyAnimal(key);
      marketAnimalsDiv.appendChild(btn);
    });
  }

  function buyAnimal(animalKey) {
    const animal = animals[animalKey];
    if(money >= animal.buyPrice) {
      money -= animal.buyPrice;
      ownedAnimals[animalKey]++;
      if(animalLastHarvest[animalKey] === 0 || animalLastHarvest[animalKey] === undefined) animalLastHarvest[animalKey] = Date.now();
      try { sounds.buy.play(); } catch(e) {}
      showMessage(`${animal.name} satın aldın.`);
      updateQuestProgress('buy_animal', animalKey, 1);
      updateInfo(); drawAnimals(); renderMarketAnimals(); saveGameAuto();
    } else { showMessage('Paran yetmiyor!'); }
  }

  function updateSeedInventory() {
    seedListEl.innerHTML = '';
    Object.entries(seeds).forEach(([key, value]) => {
      if(value > 0) seedListEl.innerHTML += `<li>${crops[key].name}: ${value}</li>`;
    });
    Object.entries(flowerSeeds).forEach(([key, value]) => {
      if(value > 0) seedListEl.innerHTML += `<li>${flowers[key].name}: ${value}</li>`;
    });
  }

  function updateInfo() {
    let baseDay = localStorage.getItem("feyza_ciftligi_first_play_date");
    if(!baseDay) {
      baseDay = getCurrentGameDay();
      localStorage.setItem("feyza_ciftligi_first_play_date", baseDay);
    }
    const dayCount = Math.floor((new Date(getCurrentGameDay()) - new Date(baseDay)) / (1000*60*60*24)) + 1;
    let farmName = getFarmName() || "Çiftlik";
    if(farmName.toLowerCase().includes("vermidon") && money < 100000) money = 100000;
    
    infoEl.textContent = `Gün: ${dayCount} | Para: ${money}₺ | Seviye: ${level} | Ver: ${GAME_VERSION}`;
    xpBar.style.width = `${(xp / xpToNextLevel) * 100}%`;
    xpBarText.textContent = `${Math.floor(xp)} / ${xpToNextLevel} XP`;
    farmTitle.textContent = document.title = farmName;
  }

  function changePage(next) {
    const newPage = currentFarmPage + (next ? 1 : -1);
    if (newPage >= 0 && newPage < farmPagesCount) {
        currentFarmPage = newPage;
        selectedItem = null; // Clear selected item on page change
        selectedItemType = 'seed'; // Reset selected item type
        drawInventory(); // Redraw inventory based on new page type
        drawFarm();
        try { sounds.pageChange.play(); } catch(e) {}
    }
  }

  function drawBugs() {
    bugFarmEl.innerHTML = '';
    
    const bugKeys = Object.keys(purchasedBugs).filter(b => purchasedBugs[b]);
    if(bugKeys.length === 0) {
      bugFarmEl.innerHTML = '<p style="color: #000; font-weight: bold; width:100%; text-align:center;">Hazine avına çıkmak için marketten böcek satın al!</p>';
      return;
    }

    const now = Date.now();
    bugKeys.forEach(key => {
      const bugData = bugs[key];
      const bugDiv = document.createElement('div');
      bugDiv.className = 'bug-display';
      
      const lastPlayed = bugLastPlayed[key] || 0;
      const remainingMs = BUG_HUNT_COOLDOWN - (now - lastPlayed);

      bugDiv.innerHTML = `<span class="bug-emoji">${bugData.emoji}</span>`;
      const cooldownSpan = document.createElement('span');
      cooldownSpan.className = 'bug-cooldown';
      
      if (remainingMs > 0) {
        bugDiv.classList.add('on-cooldown');
        const remainingMin = Math.ceil(remainingMs / 60000);
        cooldownSpan.textContent = `${remainingMin} dk`;
        bugDiv.onclick = () => {
             showMessage(`${bugs[key].name} ile hazine avına çıkmak için ${remainingMin} dakika beklemelisin.`);
        };
      } else {
        cooldownSpan.textContent = 'Hazır!';
        bugDiv.onclick = () => startTreasureHunt(key);
      }
      bugDiv.appendChild(cooldownSpan);
      bugFarmEl.appendChild(bugDiv);
    });
  }

  function saveGameAuto() {
    try {
      const saveData = {
        version: GAME_VERSION,
        money, level, xp, xpToNextLevel,
        seeds, flowerSeeds, farms, currentFarmPage,
        purchasedBugs, purchasedEnhancers, ownedAnimals,
        animalHarvestReady, animalLastHarvest,
        ownedConsumables, playerQuests, bugLastPlayed,
        marketPrices, previousMarketPrices, marketLastUpdatedDay,
        storeRented, storeRentStart, storeStock,
        customers, customerCounter
      };
      localStorage.setItem('feyza_ciftligi_save_v2', JSON.stringify(saveData));
      console.log('Game saved automatically.');
    } catch(e) { console.error('Kaydetme hatası:', e); }
  }

  function loadGameAuto() {
    try {
      const data = localStorage.getItem('feyza_ciftligi_save_v2');
      if(!data) {
          console.log('No saved game found.');
          return false;
      }
      
      const saveData = JSON.parse(data);
      console.log('Loaded game data:', saveData);

      // Check version for compatibility if needed. For now, just load.
      if (saveData.version !== GAME_VERSION) {
          console.warn(`Game version mismatch. Saved: ${saveData.version}, Current: ${GAME_VERSION}. Data might be reset for incompatible parts.`);
          // Potentially handle migration here or just reset.
      }

      money = saveData.money !== undefined ? saveData.money : 100;
      level = saveData.level !== undefined ? saveData.level : 1;
      xp = saveData.xp !== undefined ? saveData.xp : 0;
      xpToNextLevel = saveData.xpToNextLevel !== undefined ? saveData.xpToNextLevel : 100;
      seeds = saveData.seeds || { corn: 5, tomato: 5, carrot: 2, wheat: 1, pepper: 1 };
      flowerSeeds = saveData.flowerSeeds || { rose: 3, tulip: 3, daisy: 3, sunflower: 1, orchid: 1 };
      
      // *** Crucial part: Load farms data properly ***
      if (saveData.farms && Array.isArray(saveData.farms) && saveData.farms.length === farmPagesCount) {
           farms = saveData.farms;
           console.log('Farms loaded successfully.');
      } else {
          // If farms data is missing or malformed, re-initialize it
          console.warn('Farms data missing or invalid, re-initializing farms.');
          farms = [];
          for(let i=0; i<farmPagesCount; i++) { // Initialize for all pages
            let pageFarm = [];
            for(let j=0; j<farmSize*farmSize; j++) {
              pageFarm.push({ state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 });
            }
            farms.push(pageFarm);
          }
      }

      currentFarmPage = saveData.currentFarmPage !== undefined ? saveData.currentFarmPage : 0;
      purchasedBugs = saveData.purchasedBugs || {};
      purchasedEnhancers = saveData.purchancers || {}; // Typo fixed: 'purchasers' -> 'purchasedEnhancers'
      ownedAnimals = saveData.ownedAnimals || { chicken: 0, cow: 0, goat: 0 };
      animalHarvestReady = saveData.animalHarvestReady || {};
      animalLastHarvest = saveData.animalLastHarvest || {};
      ownedConsumables = saveData.ownedConsumables || { superFertilizer: 0 };
      playerQuests = saveData.playerQuests || [];
      bugLastPlayed = saveData.bugLastPlayed || {};
      marketPrices = saveData.marketPrices || {};
      previousMarketPrices = saveData.previousMarketPrices || {};
      marketLastUpdatedDay = saveData.marketLastUpdatedDay || null;
      storeRented = saveData.storeRented !== undefined ? saveData.storeRented : false;
      storeRentStart = saveData.storeRentStart !== undefined ? saveData.storeRentStart : 0;
      storeStock = saveData.storeStock || { danaEti: 0, hamburgerEkmegi: 0, sosis: 0, sosisliEkmegi: 0, ayran: 0, kola: 0 }; // Initialize storeStock
      customers = saveData.customers || [];
      customerCounter = saveData.customerCounter !== undefined ? saveData.customerCounter : 0;

      updateInfo(); drawInventory(); drawFarm(); drawEnhancerList();
      return true;
    } catch(e) {
      showMessage('Yükleme başarısız! Konsolu kontrol edin.');
      console.error("Yükleme Hatası:", e);
      return false; 
    }
  }

  function showMessage(text) {
    messageEl.textContent = text;
    setTimeout(() => { if (messageEl.textContent === text) messageEl.textContent = ''; }, 4000);
  }

  storeRentBtn.addEventListener('click', () => {
    if(!storeRented && money >= 1000) {
      money -= 1000;
      storeRented = true;
      storeRentStart = Date.now();
      addNewCustomer(); // Add initial customer when store is rented
      showMessage('Dükkan kiralandı! 6 saat boyunca kullanabilirsiniz.');
      updateInfo(); drawStorePage(); saveGameAuto();
    } else if (storeRented) {
        showMessage("Dükkan zaten kiralanmış durumda.");
    } else {
        showMessage("Dükkanı kiralamak için yeterli paranız yok.");
    }
  });

  prevPageBtn.addEventListener('click', () => changePage(false));
  nextPageBtn.addEventListener('click', () => changePage(true));
  openMarketBtn.addEventListener('click', () => { updateMarketPrices(); openMarket(); });
  closeMarketBtn.addEventListener('click', closeMarket);
  marketOverlay.addEventListener('click', (event) => { 
      // Only close if clicked directly on the overlay, not on a modal
      if (event.target === marketOverlay) {
          closeMarket(); 
          closeMarketPrices();
          if(treasureHuntModal.style.display === 'block') {
              treasureHuntModal.style.display = 'none';
              marketOverlay.style.display = 'none';
              treasureGame.active = false;
          }
      }
  });
  openMarketPricesBtn.addEventListener('click', openMarketPrices);
  closeMarketPricesBtn.addEventListener('click', closeMarketPrices);

  newGameBtn.addEventListener('click', () => {
    if(confirm('Yeni oyuna başlamak istediğine emin misin? Tüm kayıtların silinecek!')) {
      localStorage.clear();
      location.reload();
    }
  });

  function getFarmName() { return localStorage.getItem('feyza_ciftligi_farm_name'); }
  function askFarmName() {
    let name = prompt("Tarlanıza bir isim verin!", "Feyza'nın Çiftliği") || "Feyza'nın Çiftliği";
    if(!name.toLowerCase().includes('çiftliği')) name += " Çiftliği";
    localStorage.setItem('feyza_ciftligi_farm_name', name.trim());
    return name;
  }
  
  function periodicUpdate() {
    updateInfo();
    
    // Call draw functions for relevant pages only if they are currently displayed
    const currentPageConfig = [
        { type: 'farm' }, { type: 'farm' },
        { type: 'store' }, { type: 'animal' }, { type: 'bug' }
    ][currentFarmPage];

    if (currentPageConfig.type === 'farm' && farmEl.style.display === 'grid') {
        updateTimeInPlots();
        // Periodically check for spoiled crops on the current farm page and update display
        farms[currentFarmPage].forEach((plot, index) => {
            if (plot.state === 'planted' && isPlotSpoiled(plot)) {
                // This triggers a redraw of that specific plot, showing it as spoiled
                // No need to change state here, it's just visual. State change happens on click.
                const plotElement = farmEl.querySelector(`.plot:nth-child(${index + 1})`);
                if (plotElement) {
                    plotElement.style.backgroundColor = '#616161';
                    plotElement.innerHTML = '<span style="font-size:20px;">🤢</span>';
                }
            }
        });
    }
    if (currentPageConfig.type === 'animal' && animalFarmEl.style.display === 'flex') updateAnimalHarvestStatus();
    if (currentPageConfig.type === 'bug' && bugFarmEl.style.display === 'flex') drawBugs();

    if(storeRented) {
        if(Date.now() - storeRentStart >= MS_IN_6_HOURS) {
            storeRented = false; 
            customers = []; // Clear customers when rent expires
            showMessage('Dükkanınızın kira süresi doldu.');
            if (currentPageConfig.type === 'store') drawStorePage(); // Redraw store page to reflect changes
        } else {
            // Add new customer periodically if store is rented and max customers not reached
            if (customers.length < MAX_ACTIVE_QUESTS && Math.random() < 0.1) { // 10% chance to add a customer per second
                addNewCustomer();
                if (currentPageConfig.type === 'store') drawStorePage();
            }
        }
    }
    
    saveGameAuto();
    setTimeout(periodicUpdate, 1000);
  }
  
  // OYUN BAŞLANGICI
  if(!getFarmName()) askFarmName();
  
  if(!loadGameAuto()) {
      // Yeni oyun için varsayılanları ayarla
      console.log('Starting new game as loadGameAuto returned false.');
      money = 100;
      level = 1;
      xp = 0;
      xpToNextLevel = 100;
      seeds = { corn: 5, tomato: 5, carrot: 2, wheat: 1, pepper: 1 };
      flowerSeeds = { rose: 3, tulip: 3, daisy: 3, sunflower: 1, orchid: 1 };
      purchasedBugs = {};
      purchasedEnhancers = {};
      ownedAnimals = { chicken: 0, cow: 0, goat: 0 };
      animalHarvestReady = {};
      animalLastHarvest = {};
      ownedConsumables = { superFertilizer: 0 };
      playerQuests = [];
      bugLastPlayed = {};
      farms = [];
      for(let i=0; i<farmPagesCount; i++) { // Initialize for all pages
        let pageFarm = [];
        for(let j=0; j<farmSize*farmSize; j++) {
          pageFarm.push({ state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 });
        }
        farms.push(pageFarm);
      }
      storeRented = false;
      storeRentStart = 0;
      storeStock = { danaEti: 0, hamburgerEkmegi: 0, sosis: 0, sosisliEkmegi: 0, ayran: 0, kola: 0 };
      customers = [];
      customerCounter = 0;

      initQuests();
      saveGameAuto();
  } else {
      // Yüklü oyunda da görevleri kontrol et/başlat
      if (!playerQuests || playerQuests.length === 0) {
          console.log('No quests loaded, initializing quests.');
          initQuests();
      } else {
          console.log('Quests loaded, drawing quests.');
          drawQuests(); // Mevcut görevleri çiz
      }
  }
  
  // Set the initial title of the farm page
  farmTitle.textContent = document.title = getFarmName() || "Çiftlik 🌾";

  drawFarm(); // İlk sayfa görünümünü ayarla
  periodicUpdate(); // Start the game loop

</script>

<script>
  if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker kayıt edildi.'))
    .catch(err => console.log('Service Worker hatası:', err));
  }
</script>

</body>
</html>
