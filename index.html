<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>√áiftlik üåæ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#388e3c" />

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e8f5e9;
    margin: 0; padding: 20px;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
  }
  #leftPanel {
    flex: none;
    width: 100%;
    max-width: 450px;
    text-align: center;
  }
  #info { font-size: 18px; margin-bottom: 12px; }
  #inventory {
    display: flex; justify-content: center;
    margin-bottom: 15px; gap: 10px;
    flex-wrap: wrap;
  }
  .inv-item {
    cursor: pointer; font-size: 28px; padding: 5px 10px;
    border-radius: 8px; background-color: #81c784;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    user-select: none; border: 3px solid transparent;
    transition: border-color 0.3s;
    display: flex; align-items: center; gap: 6px;
    color: white; font-weight: bold;
  }
  .inv-item.selected { border-color: #33691e; }
  .inv-count { font-size: 18px; user-select: none; color: #1b5e20; }
  #farm {
    display: grid;
    grid-template-columns: repeat(5, 80px);
    grid-gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
    min-height: 400px;
  }
  .plot {
    width: 80px; height: 80px; background: #7b4f24;
    border-radius: 8px; cursor: pointer;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-weight: bold; color: white;
    box-shadow: 0 0 4px #000000aa;
    transition: background 0.3s; font-size: 30px;
    user-select: none;
    position: relative;
    flex-shrink: 0;
  }
  .plot.planted { background: #3e7d0a; }
  .plot.grown {
    background: #4caf50; color: #003300; font-size: 40px;
  }
  button {
    padding: 10px 20px; font-size: 16px; border-radius: 6px;
    border: none; background-color: #388e3c; color: white;
    cursor: pointer; transition: background-color 0.3s;
    margin: 5px; user-select: none;
  }
  button:hover:enabled { background-color: #2e7d32; }
  button:disabled {
    background-color: #a5d6a7; cursor: not-allowed;
  }
  #controls { margin-bottom: 15px; }
  #message {
    height: 24px; font-weight: bold; color: #2e7d32;
    margin-bottom: 12px; min-height: 24px;
  }
  #marketModal, #marketOverlay, #marketPricesModal {
    user-select: none;
  }
  #marketOverlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3); z-index: 900;
  }
  #marketModal, #marketPricesModal {
    display: none; position: fixed; top: 50%; left: 50%;
    width: 380px; background: white; border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    transform: translate(-50%, -50%);
    padding: 20px; z-index: 1000; max-height: 80vh;
    overflow-y: auto;
  }
  #marketModal h2, #marketModal h3, #marketPricesModal h2 {
    margin-top: 0; margin-bottom: 10px;
  }
  #marketModal .seedBtn, #marketModal .bugBtn, #marketModal .enhancerBtn, #marketModal .animalBtn {
    display: flex; align-items: center; justify-content: space-between;
    background: #81c784; color: #004d00;
    margin: 6px 0; padding: 8px 12px; border-radius: 6px;
    cursor: pointer; font-weight: bold; font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.3s;
  }
  #marketModal .seedBtn:disabled, #marketModal .bugBtn:disabled, #marketModal .enhancerBtn:disabled, #marketModal .animalBtn:disabled {
    background: #c8e6c9; color: #888; cursor: not-allowed;
    box-shadow: none;
  }
  #pagination {
    margin-bottom: 20px;
  }
  #pagination button {
    width: 40px; font-weight: bold; font-size: 18px; padding: 6px 0;
  }
  #bugFarm {
    width: 400px; height: 400px; background-color: #2196f3;
    border-radius: 12px; margin: 0 auto 20px;
    position: relative;
    cursor: default;
    overflow: hidden;
  }
  #animalFarm {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
    margin-bottom: 20px;
  }
  .animal {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    user-select: none;
    background: #81c784;
    border-radius: 10px;
    padding: 12px 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 320px;
    color: #004d00;
    font-weight: bold;
    font-size: 24px;
    position: relative;
  }
  .animal-emoji {
    font-size: 48px;
  }
  .animal-count {
    font-size: 18px;
    margin-top: 6px;
  }
  .harvest-status {
    font-weight: bold;
    color: #aed581;
    font-size: 14px;
    margin-top: 4px;
    user-select: none;
  }
  @media (max-width: 650px) {
    body {
      flex-direction: column;
      padding: 8px;
      gap: 8px;
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    #leftPanel {
      width: 100%;
      max-width: 100vw;
      min-width: unset;
      padding: 8px !important;
      box-sizing: border-box;
    }
    #farm {
      grid-template-columns: repeat(3, 1fr);
      min-height: 220px;
      grid-gap: 5px;
    }
    .plot {
      width: 60px;
      height: 60px;
      font-size: 22px;
    }
    .plot.grown {
      font-size: 28px;
    }
    #bugFarm {
      width: 98vw;
      height: 210px;
      margin: 0 auto 10px;
    }
    #animalFarm {
      width: 98vw;
      max-width: unset;
    }
    #pagination button {
      width: 28px;
      font-size: 14px;
      padding: 3px 0;
    }
    button {
      font-size: 14px;
      padding: 8px 6px;
    }
    #marketModal, #marketPricesModal {
      width: 98vw !important;
      min-width: unset;
      max-width: 420px;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 10px;
    }
  }
</style>
</head>
<body>

<div id="leftPanel">
  <h1 id="farmTitle">√áiftlik üåæ</h1>
  <div id="info">G√ºn: 1 | Para: 100‚Ç∫ | Versiyon: 2.0.0</div>
  <div id="message"></div>

  <div id="inventory"></div>

  <div id="pagination">
    <button id="prevPageBtn" disabled>‚Üê</button>
    <span id="pageIndicator">Tarla 1 / 4</span>
    <button id="nextPageBtn">‚Üí</button>
  </div>

  <div id="farm"></div>

  <div id="bugFarm" style="display:none;" title="B√∂cek Tarlasƒ±"></div>
  
  <div id="animalFarm" style="display:none;"></div>

  <div id="controls">
    <button id="openMarketBtn">Market A√ß</button>
    <button id="openMarketPricesBtn">Piyasa A√ß</button>
    <button id="newGameBtn">Yeni Oyun</button>
  </div>
</div>

<div id="marketOverlay"></div>

<div id="marketModal">
  <h2>Market</h2>
  <h3>Tohumlar</h3>
  <div id="marketSeeds"></div>
  <h3>B√∂cekler</h3>
  <div id="marketBugs"></div>
  <h3>G√º√ßlendiriciler</h3>
  <div id="marketEnhancers"></div>
  <h3>Hayvanlar</h3>
  <div id="marketAnimals"></div>
  <div id="seedInventory">
    <p>Tohumlarƒ±nƒ±z:</p>
    <ul id="seedList"></ul>
    <p>G√º√ßlendiriciler:</p>
    <ul id="enhancerList"></ul>
  </div>
  <button id="closeMarketBtn" style="margin-top:15px;">Kapat</button>
</div>

<div id="marketPricesModal">
  <h2>Piyasa</h2>
  <div id="marketPricesList"></div>
  <button id="closeMarketPricesBtn" style="margin-top:15px;">Kapat</button>
</div>

<script>
  // Sesler
  const sounds = {
    plant: new Audio('data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAgD4AAIA+AAABAAgAZGF0YVAAAABZ'),
    harvest: new Audio('data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAABAAgAZGF0YYAAAABZ'),
    buy: new Audio('data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAgD4AAIA+AAABAAgAZGF0YRAAAA==')
  };

  const GAME_VERSION = '2.0.0';

  const infoEl = document.getElementById('info');
  const messageEl = document.getElementById('message');
  const inventoryEl = document.getElementById('inventory');
  const farmEl = document.getElementById('farm');
  const bugFarmEl = document.getElementById('bugFarm');
  const animalFarmEl = document.getElementById('animalFarm');
  const openMarketBtn = document.getElementById('openMarketBtn');
  const openMarketPricesBtn = document.getElementById('openMarketPricesBtn');
  const marketModal = document.getElementById('marketModal');
  const marketOverlay = document.getElementById('marketOverlay');
  const closeMarketBtn = document.getElementById('closeMarketBtn');
  const marketSeedsDiv = document.getElementById('marketSeeds');
  const marketBugsDiv = document.getElementById('marketBugs');
  const marketEnhancersDiv = document.getElementById('marketEnhancers');
  const marketAnimalsDiv = document.getElementById('marketAnimals');
  const seedListEl = document.getElementById('seedList');
  const enhancerListEl = document.getElementById('enhancerList');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const pageIndicator = document.getElementById('pageIndicator');
  const marketPricesModal = document.getElementById('marketPricesModal');
  const marketPricesList = document.getElementById('marketPricesList');
  const closeMarketPricesBtn = document.getElementById('closeMarketPricesBtn');
  const newGameBtn = document.getElementById('newGameBtn');
  const farmTitle = document.getElementById('farmTitle');

  const farmPagesCount = 4;
  const farmSize = 5;
  const MS_IN_MINUTE = 60000;
  const MS_IN_HALF_HOUR = 1800000;

  const crops = {
    corn:    { name: 'Mƒ±sƒ±r', growTimeMinutes: 20, price: 15, emoji: 'üåΩ', seedPrice: 10 },
    tomato:  { name: 'Domates', growTimeMinutes: 16, price: 10, emoji: 'üçÖ', seedPrice: 8 },
    carrot:  { name: 'Havu√ß', growTimeMinutes: 45, price: 12, emoji: 'ü•ï', seedPrice: 9 },
    wheat:   { name: 'Buƒüday', growTimeMinutes: 60, price: 18, emoji: 'üåæ', seedPrice: 14 },
    pepper:  { name: 'Biber', growTimeMinutes: 25, price: 20, emoji: 'üå∂Ô∏è', seedPrice: 15 }
  };

  const flowers = {
    rose:      { name: 'G√ºl', growTimeMinutes: 8, price: 11, emoji: 'üåπ', seedPrice: 9 },
    tulip:     { name: 'Lale', growTimeMinutes: 7, price: 10, emoji: 'üå∑', seedPrice: 9 },
    daisy:     { name: 'Papatya', growTimeMinutes: 5, price: 11, emoji: 'üåº', seedPrice: 9 },
    sunflower: { name: 'Ay√ßi√ßeƒüi', growTimeMinutes: 9, price: 12, emoji: 'üåª', seedPrice: 15 },
    orchid:    { name: 'Orkide', growTimeMinutes: 10, price: 13, emoji: 'üíê', seedPrice: 9 }
  };

  const bugs = {
    spider:      { name: '√ñr√ºmcek', emoji: 'üï∑Ô∏è', price: 1000 },
    ladybug:     { name: 'Uƒüur B√∂ceƒüi', emoji: 'üêû', price: 1000 },
    ant:         { name: 'Karƒ±nca', emoji: 'üêú', price: 1000 },
    beetle:      { name: 'B√∂cek', emoji: 'üêõ', price: 1100 },
    caterpillar: { name: 'Tƒ±rtƒ±l', emoji: 'üêõ', price: 1200 },
    centipede:   { name: 'Kƒ±rkayak', emoji: 'üêõ', price: 1300 },
    mantis:      { name: 'Sinek Kapan', emoji: 'ü¶ó', price: 1400 }
  };

  const enhancers = {
    fastHarvest:   { name: 'Hƒ±zlƒ± Hasat G√º√ßlendirici', description: 'Ekinlerin olgunla≈üma s√ºresi %20 azalƒ±r.', price: 5000 },
    fertileSoil:   { name: 'Verimli Toprak', description: 'Hasattan elde edilen para %20 artar.', price: 9000 },
    richSeed:      { name: 'Zengin Tohum', description: 'Hasatta %30 ihtimalle +1 ek √ºr√ºn verir.', price: 12000 },
    freshKeeper:   { name: 'Tazelik Koruyucu', description: 'Bozulma s√ºresini 48 saate √ßƒ±karƒ±r.', price: 8000 }
  };

  const animals = {
    chicken: { name: 'Tavuk', emoji: 'üêî', buyPrice: 300, productPrice: 25 },
    cow:     { name: 'ƒ∞nek', emoji: 'üêÑ', buyPrice: 500, productPrice: 50 },
    goat:    { name: 'Ke√ßi', emoji: 'üêê', buyPrice: 1200, productPrice: 120 }
  };

  let money = 100;

  let seeds = { corn: 5, tomato: 5, carrot: 2, wheat: 1, pepper: 1 };
  let flowerSeeds = { rose: 3, tulip: 3, daisy: 3, sunflower: 1, orchid: 1 };
  let purchasedBugs = {};
  let purchasedEnhancers = {};
  let ownedAnimals = { chicken: 0, cow: 0, goat: 0 };
  let animalHarvestReady = { chicken: false, cow: false, goat: false };
  let animalLastHarvest = { chicken: 0, cow: 0, goat: 0 };

  let farms = [];
  for(let i=0; i<farmPagesCount-1; i++) {
    let pageFarm = [];
    for(let j=0; j<farmSize*farmSize; j++) {
      pageFarm.push({
        state: 'empty',
        cropType: null,
        plantedAt: null,
        growTimeMinutes: 0
      });
    }
    farms.push(pageFarm);
  }
  farms.push([{ bugType: null, x: 0, y: 0 }]);

  let currentFarmPage = 0;
  let selectedSeedKey = null;
  let selectedSeedCategory = 'crops';

  const allProducts = {...crops, ...flowers};

  let marketPrices = {};
  let previousMarketPrices = {};
  let marketLastUpdatedDay = null;

  function getCurrentGameDay() {
    const now = new Date();
    return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
  }

  function updateMarketPrices() {
    const currentDay = getCurrentGameDay();
    if(currentDay === marketLastUpdatedDay) return;
    marketLastUpdatedDay = currentDay;

    previousMarketPrices = {...marketPrices};
    
    Object.keys(crops).forEach(key => {
      let basePrice = crops[key].price;
      let change = 0;

      if(Math.random() < 0.10) change = -0.10;
      else if(Math.random() < 0.05) change = 1.00;
      else change = (Math.random() * 0.6) - 0.10;

      let price = Math.max(1, Math.floor(basePrice * (1 + change)));
      marketPrices[key] = price;
    });

    Object.keys(flowers).forEach(key => {
      const price = Math.floor(Math.random() * (8 - 4 + 1)) + 4;
      marketPrices[key] = price;
    });
  }

  function profitEmoji(todayPrice, yesterdayPrice) {
    if(yesterdayPrice === undefined) return '‚ûñ';
    if(todayPrice > yesterdayPrice) return '‚¨ÜÔ∏è';
    if(todayPrice < yesterdayPrice) return '‚¨áÔ∏è';
    return '‚ûñ';
  }

  function openMarketPrices() {
    renderMarketPrices();
    marketPricesModal.style.display = 'block';
    marketOverlay.style.display = 'block';
  }

  function closeMarketPrices() {
    marketPricesModal.style.display = 'none';
    marketOverlay.style.display = 'none';
  }

  function renderMarketPrices() {
    marketPricesList.innerHTML = '';
    for(const key in marketPrices) {
      // Sadece sebzeler g√∂sterilecek
      if(!(key in crops)) continue;

      const p = document.createElement('p');
      const product = crops[key];
      const emoji = profitEmoji(marketPrices[key], previousMarketPrices[key]);
      const seedPrice = product.seedPrice !== undefined ? product.seedPrice : product.price;
      p.innerHTML = `${product.emoji} ${product.name}: ${marketPrices[key]}‚Ç∫ (Normal: ${seedPrice}‚Ç∫) <span class="profit-emoji">${emoji}</span>`;
      marketPricesList.appendChild(p);
    }
  }

  function drawInventory() {
    inventoryEl.innerHTML = '';
    const sourceSeeds = selectedSeedCategory === 'crops' ? seeds : flowerSeeds;
    const sourceCrops = selectedSeedCategory === 'crops' ? crops : flowers;

    for(const key in sourceSeeds) {
      const btn = document.createElement('div');
      btn.className = 'inv-item';
      if(selectedSeedKey === key) btn.classList.add('selected');

      const emojiSpan = document.createElement('span');
      emojiSpan.textContent = sourceCrops[key].emoji;
      emojiSpan.style.fontSize = '32px';

      const countSpan = document.createElement('span');
      countSpan.className = 'inv-count';
      countSpan.textContent = sourceSeeds[key];

      btn.title = `${sourceCrops[key].name} (${sourceSeeds[key]} adet)`;
      btn.onclick = () => {
        if(sourceSeeds[key] > 0) {
          selectedSeedKey = key;
          drawInventory();
          showMessage(`${sourceCrops[key].name} se√ßildi.`);
        }
      };

      btn.appendChild(emojiSpan);
      btn.appendChild(countSpan);
      inventoryEl.appendChild(btn);
    }
  }

  function drawEnhancerList() {
    enhancerListEl.innerHTML = '';
    for(const key in purchasedEnhancers) {
      if(purchasedEnhancers[key]) {
        const li = document.createElement('li');
        li.textContent = enhancers[key].name;
        enhancerListEl.appendChild(li);
      }
    }
  }

  function drawFarm() {
    farmEl.innerHTML = '';
    bugFarmEl.style.display = 'none';
    animalFarmEl.style.display = 'none';

    if(currentFarmPage === farmPagesCount - 1) {
      farmEl.style.display = 'none';
      bugFarmEl.style.display = 'block';
      animalFarmEl.style.display = 'none';
      pageIndicator.textContent = `Tarla ${currentFarmPage + 1} / ${farmPagesCount}`;
      prevPageBtn.disabled = false;
      nextPageBtn.disabled = true;
      drawBugs();
      return;
    }

    if(currentFarmPage === farmPagesCount - 2) {
      farmEl.style.display = 'none';
      bugFarmEl.style.display = 'none';
      animalFarmEl.style.display = 'flex';
      pageIndicator.textContent = `Tarla ${currentFarmPage + 1} / ${farmPagesCount}`;
      prevPageBtn.disabled = false;
      nextPageBtn.disabled = false;
      drawAnimals();
      return;
    }

    farmEl.style.display = 'grid';

    const farm = farms[currentFarmPage];

    farm.forEach((plot, i) => {
      const plotEl = document.createElement('div');
      plotEl.classList.add('plot');

      if(currentFarmPage === 1) {
        plotEl.style.backgroundColor = '#7a4f8a';
      }

      if(plot.state === 'empty') {
        plotEl.style.backgroundColor = currentFarmPage === 1 ? '#7a4f8a' : '#7b4f24';
        plotEl.textContent = '';
      } else {
        const isReady = isPlotReady(plot);
        if(isReady) {
          plotEl.classList.add('grown');
        } else {
          plotEl.classList.add('planted');
        }
        const emoji = currentFarmPage === 1 ? flowers[plot.cropType]?.emoji || '' : crops[plot.cropType]?.emoji || '';

        const emojiSpan = document.createElement('span');
        emojiSpan.textContent = emoji;
        emojiSpan.style.display = 'block';
        emojiSpan.style.fontSize = currentFarmPage === 1 ? '36px' : '40px';
        emojiSpan.style.lineHeight = '1';

        const timeSpan = document.createElement('span');
        timeSpan.style.display = 'block';
        timeSpan.style.fontSize = '14px';
        timeSpan.style.marginTop = '2px';
        timeSpan.style.fontWeight = 'bold';
        timeSpan.style.color = '#c5e1a5';
        timeSpan.dataset.plotIndex = i;

        plotEl.appendChild(emojiSpan);
        plotEl.appendChild(timeSpan);
      }

      plotEl.onclick = () => {
        if(plot.state === 'empty') {
          if(currentFarmPage === 1) {
            if(selectedSeedCategory !== 'flowers') {
              showMessage('Bu tarlaya sadece √ßi√ßek tohumlarƒ± ekilebilir. L√ºtfen envanterden √ßi√ßek se√ßin.');
              return;
            }
            if(selectedSeedKey) {
              plantCrop(i, selectedSeedKey);
            } else {
              showMessage('L√ºtfen √ºstten bir √ßi√ßek tohumu se√ß!');
            }
          } else {
            if(selectedSeedCategory !== 'crops') {
              showMessage('Bu tarlaya sebze tohumu ekmelisin. L√ºtfen envanterden sebze se√ß!');
              return;
            }
            if(selectedSeedKey) {
              plantCrop(i, selectedSeedKey);
            } else {
              showMessage('L√ºtfen √ºstten bir tohum se√ß!');
            }
          }
        } else {
          if(isPlotReady(plot)) {
            harvestCrop(i);
          } else if(isPlotSpoiled(plot)) {
            showMessage('Bu √ºr√ºn bozuldu, hasat edemezsin!');
          } else {
            showMessage('Ekin b√ºy√ºyor, sabƒ±rlƒ± ol!');
          }
        }
      };
      farmEl.appendChild(plotEl);
    });

    pageIndicator.textContent = `Tarla ${currentFarmPage + 1} / ${farmPagesCount}`;
    prevPageBtn.disabled = currentFarmPage === 0;
    nextPageBtn.disabled = currentFarmPage === farmPagesCount - 1;

    updateTimeInPlots();
  }

  function drawAnimals() {
    animalFarmEl.innerHTML = '';

    Object.keys(animals).forEach(key => {
      const animal = animals[key];
      const count = ownedAnimals[key];
      const div = document.createElement('div');
      div.className = 'animal';
      div.title = animal.name;

      const emojiSpan = document.createElement('span');
      emojiSpan.className = 'animal-emoji';
      emojiSpan.textContent = animal.emoji;

      const countSpan = document.createElement('span');
      countSpan.className = 'animal-count';
      countSpan.textContent = `Adet: ${count}`;

      const harvestSpan = document.createElement('span');
      harvestSpan.className = 'harvest-status';

      if(count > 0) {
        if(animalHarvestReady[key]) {
          harvestSpan.textContent = 'Hasat hazƒ±r!';
        } else {
          // Kalan s√ºreyi g√∂ster
          const now = Date.now();
          const elapsed = now - animalLastHarvest[key];
          const remaining = MS_IN_HALF_HOUR - elapsed;
          if(remaining > 0) {
            const min = Math.floor(remaining / 60000);
            const sec = Math.floor((remaining % 60000) / 1000);
            harvestSpan.textContent = `Hasat: ${min}:${sec.toString().padStart(2,'0')}`;
          } else {
            harvestSpan.textContent = 'Hasat hazƒ±r!';
          }
        }
      } else {
        harvestSpan.textContent = '';
      }

      div.appendChild(emojiSpan);
      div.appendChild(countSpan);
      div.appendChild(harvestSpan);

      div.onclick = () => {
        if(count === 0) {
          showMessage(`${animal.name} satƒ±n alƒ±nmamƒ±≈ü!`);
          return;
        }
        if(animalHarvestReady[key]) {
          const totalIncome = count * animal.productPrice;
          money += totalIncome;
          animalHarvestReady[key] = false;
          animalLastHarvest[key] = Date.now();
          showMessage(`${animal.name} hasat edildi! +${totalIncome}‚Ç∫`);
          updateInfo();
          drawAnimals();
          saveGameAuto();
          sounds.harvest.play();
        } else {
          showMessage(`${animal.name} i√ßin hasat hazƒ±r deƒüil.`);
        }
      };

      animalFarmEl.appendChild(div);
    });
  }

  function updateTimeInPlots() {
    const farm = farms[currentFarmPage];
    const now = Date.now();
    const plotTimeSpans = farmEl.querySelectorAll('span[data-plot-index]');
    plotTimeSpans.forEach(span => {
      const i = parseInt(span.dataset.plotIndex);
      const plot = farm[i];
      if(!plot || plot.state !== 'planted' || !plot.plantedAt) {
        span.textContent = '';
        return;
      }
      const growTimeMs = getEffectiveGrowTime(plot) * MS_IN_MINUTE;
      const elapsedMs = now - plot.plantedAt;
      const remainingMs = growTimeMs - elapsedMs;

      if(isPlotSpoiled(plot)) {
        span.textContent = 'BOZULDU!';
        span.style.color = '#b71c1c';
      } else if(isPlotReady(plot)) {
        span.textContent = 'Hasat hazƒ±r!';
        span.style.color = '#aed581';
      } else {
        const remSec = Math.max(0, Math.floor(remainingMs / 1000));
        const remMin = Math.floor(remSec / 60);
        const remS = remSec % 60;
        span.textContent = `${remMin}:${remS.toString().padStart(2,'0')}`;
        span.style.color = '#c5e1a5';
      }
    });
  }

  function updateAnimalHarvestStatus() {
    const now = Date.now();
    Object.keys(ownedAnimals).forEach(key => {
      if(ownedAnimals[key] > 0) {
        if(animalLastHarvest[key] === 0) {
          animalHarvestReady[key] = false;
        } else {
          animalHarvestReady[key] = (now - animalLastHarvest[key]) >= MS_IN_HALF_HOUR;
        }
      } else {
        animalHarvestReady[key] = false;
        animalLastHarvest[key] = 0;
      }
    });
  }

  function isPlotReady(plot) {
    if(plot.state !== 'planted') return false;
    if(!plot.plantedAt) return false;
    const now = Date.now();
    const elapsedMinutes = (now - plot.plantedAt) / MS_IN_MINUTE;
    return elapsedMinutes >= getEffectiveGrowTime(plot);
  }

  function getEffectiveGrowTime(plot) {
    let t = plot.growTimeMinutes;
    if(purchasedEnhancers.fastHarvest) t = Math.floor(t * 0.8);
    return t;
  }

  function isPlotSpoiled(plot) {
    if(plot.state !== 'planted' || !plot.plantedAt) return false;
    const now = Date.now();
    const elapsedMinutes = (now - plot.plantedAt) / MS_IN_MINUTE;
    const readyTime = getEffectiveGrowTime(plot);
    const maxHours = purchasedEnhancers.freshKeeper ? 48 : 24;
    const spoilMinutes = maxHours * 60;
    return elapsedMinutes >= (readyTime + spoilMinutes);
  }

  function plantCrop(index, cropKey) {
    let sourceSeeds, cropData;

    if(currentFarmPage === 1) {
      sourceSeeds = flowerSeeds;
      cropData = flowers[cropKey];
    } else {
      sourceSeeds = seeds;
      cropData = crops[cropKey];
    }

    if(sourceSeeds[cropKey] <= 0) {
      showMessage('Bu tohumdan stokta kalmadƒ±!');
      return;
    }

    let growTime = cropData.growTimeMinutes;

    let farm = farms[currentFarmPage];
    farm[index] = {
      state: 'planted',
      cropType: cropKey,
      plantedAt: Date.now(),
      growTimeMinutes: growTime
    };

    sourceSeeds[cropKey]--;
    sounds.plant.play();
    showMessage(`${cropData.name} ektin!`);
    updateInfo();
    drawInventory();
    drawFarm();
    saveGameAuto();
  }

  function harvestCrop(index) {
    let farm = farms[currentFarmPage];
    const plot = farm[index];
    const cropKey = plot.cropType;

    let cropData;
    if(currentFarmPage === 1) {
      cropData = flowers[cropKey];
    } else {
      cropData = crops[cropKey];
    }

    if(isPlotSpoiled(plot)) {
      farm[index] = { state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 };
      showMessage(`${cropData.name} bozulmu≈ü, hasat edilemedi! üò¢`);
      drawFarm();
      saveGameAuto();
      return;
    }

    let gain;
    if(currentFarmPage === 1) {
      // √ái√ßek hasat kazancƒ± tohum fiyatƒ±ndan minimum 20‚Ç∫ fazla olacak
      gain = Math.max(cropData.seedPrice + 20, Math.floor(cropData.price * 1.10));
    } else {
      gain = marketPrices[cropKey] || cropData.price;
      if(purchasedEnhancers.fertileSoil) {
        gain = Math.floor(gain * 1.2);
      }
    }

    let extra = 0;
    if(purchasedEnhancers.richSeed && Math.random() < 0.3) {
      extra = 1;
    }
    let totalGain = gain * (1 + extra);

    money = money === Infinity ? money : money + totalGain;
    farm[index] = { state: 'empty', cropType: null, plantedAt: null, growTimeMinutes: 0 };
    sounds.harvest.play();
    if(extra)
      showMessage(`${cropData.name} hasat edildi! +${totalGain}‚Ç∫ (BONUS: +1 ek √ºr√ºn!)`);
    else
      showMessage(`${cropData.name} hasat edildi! +${gain}‚Ç∫`);
    updateInfo();
    drawFarm();
    saveGameAuto();
  }

  function openMarket() {
    marketModal.style.display = 'block';
    marketOverlay.style.display = 'block';
    renderMarketSeeds();
    renderMarketBugs();
    renderMarketEnhancers();
    renderMarketAnimals();
    updateSeedInventory();
    drawEnhancerList();
  }

  function closeMarket() {
    marketModal.style.display = 'none';
    marketOverlay.style.display = 'none';
  }

  function renderMarketSeeds() {
    marketSeedsDiv.innerHTML = '';
    for(const key in crops) {
      const btn = document.createElement('button');
      btn.classList.add('seedBtn');
      btn.textContent = `${crops[key].emoji} ${crops[key].name} Tohumu - ${crops[key].seedPrice}‚Ç∫`;
      btn.disabled = money !== Infinity && money < crops[key].seedPrice;
      btn.onclick = () => buySeed(key);
      marketSeedsDiv.appendChild(btn);
    }
    for(const key in flowers) {
      const btn = document.createElement('button');
      btn.classList.add('seedBtn');
      btn.textContent = `${flowers[key].emoji} ${flowers[key].name} Tohumu - ${flowers[key].seedPrice}‚Ç∫`;
      btn.disabled = money !== Infinity && money < flowers[key].seedPrice;
      btn.onclick = () => buySeedFlower(key);
      marketSeedsDiv.appendChild(btn);
    }
  }

  function buySeed(seedKey) {
    if(money === Infinity || money >= crops[seedKey].seedPrice) {
      if(money !== Infinity) money -= crops[seedKey].seedPrice;
      seeds[seedKey]++;
      sounds.buy.play();
      showMessage(`${crops[seedKey].name} tohumu satƒ±n aldƒ±n.`);
      updateInfo();
      drawInventory();
      renderMarketSeeds();
      saveGameAuto();
      const btns = marketSeedsDiv.querySelectorAll('button');
      btns.forEach(btn => {
        if(btn.textContent.includes(crops[seedKey].name)) flashButton(btn);
      });
    } else {
      showMessage('Paran yetmiyor!');
    }
  }
  function buySeedFlower(seedKey) {
    if(money === Infinity || money >= flowers[seedKey].seedPrice) {
      if(money !== Infinity) money -= flowers[seedKey].seedPrice;
      flowerSeeds[seedKey]++;
      sounds.buy.play();
      showMessage(`${flowers[seedKey].name} tohumu satƒ±n aldƒ±n.`);
      updateInfo();
      drawInventory();
      renderMarketSeeds();
      saveGameAuto();
      const btns = marketSeedsDiv.querySelectorAll('button');
      btns.forEach(btn => {
        if(btn.textContent.includes(flowers[seedKey].name)) flashButton(btn);
      });
    } else {
      showMessage('Paran yetmiyor!');
    }
  }

  function renderMarketBugs() {
    marketBugsDiv.innerHTML = '';
    for(const key in bugs) {
      const btn = document.createElement('button');
      btn.classList.add('bugBtn');
      btn.textContent = `${bugs[key].emoji} ${bugs[key].name} - ${bugs[key].price}‚Ç∫`;
      btn.disabled = purchasedBugs[key] || (money !== Infinity && money < bugs[key].price);
      btn.onclick = () => buyBug(key);
      marketBugsDiv.appendChild(btn);
    }
  }

  function buyBug(bugKey) {
    if(purchasedBugs[bugKey]) {
      showMessage('Bu b√∂ceƒüi zaten satƒ±n aldƒ±n!');
      return;
    }
    if(money === Infinity || money >= bugs[bugKey].price) {
      if(money !== Infinity) money -= bugs[bugKey].price;
      purchasedBugs[bugKey] = true;
      sounds.buy.play();
      showMessage(`${bugs[bugKey].name} satƒ±n alƒ±ndƒ±!`);
      updateInfo();
      renderMarketBugs();
      drawBugs();
      saveGameAuto();
      const btns = marketBugsDiv.querySelectorAll('button');
      btns.forEach(btn => {
        if(btn.textContent.includes(bugs[bugKey].name)) flashButton(btn);
      });
    } else {
      showMessage('Paran yetmiyor!');
    }
  }

  function renderMarketEnhancers() {
    marketEnhancersDiv.innerHTML = '';
    for(const key in enhancers) {
      const btn = document.createElement('button');
      btn.classList.add('enhancerBtn');
      btn.textContent = `${enhancers[key].name} - ${enhancers[key].price}‚Ç∫`;
      btn.disabled = purchasedEnhancers[key] || (money !== Infinity && money < enhancers[key].price);
      btn.title = enhancers[key].description;
      btn.onclick = () => buyEnhancer(key);
      marketEnhancersDiv.appendChild(btn);
    }
  }

  function buyEnhancer(key) {
    if(purchasedEnhancers[key]) {
      showMessage('Bu g√º√ßlendiriciyi zaten satƒ±n aldƒ±n!');
      return;
    }
    if(money === Infinity || money >= enhancers[key].price) {
      if(money !== Infinity) money -= enhancers[key].price;
      purchasedEnhancers[key] = true;
      sounds.buy.play();
      showMessage(`${enhancers[key].name} satƒ±n alƒ±ndƒ±!`);
      updateInfo();
      renderMarketEnhancers();
      drawEnhancerList();
      saveGameAuto();
      const btns = marketEnhancersDiv.querySelectorAll('button');
      btns.forEach(btn => {
        if(btn.textContent.includes(enhancers[key].name)) flashButton(btn);
      });
    } else {
      showMessage('Paran yetmiyor!');
    }
  }

  function renderMarketAnimals() {
    marketAnimalsDiv.innerHTML = '';
    for(const key in animals) {
      const btn = document.createElement('button');
      btn.classList.add('animalBtn');
      btn.textContent = `${animals[key].emoji} ${animals[key].name} - ${animals[key].buyPrice}‚Ç∫`;
      btn.disabled = money !== Infinity && money < animals[key].buyPrice;
      btn.onclick = () => buyAnimal(key);
      marketAnimalsDiv.appendChild(btn);
    }
  }

  function buyAnimal(animalKey) {
    if(money === Infinity || money >= animals[animalKey].buyPrice) {
      if(money !== Infinity) money -= animals[animalKey].buyPrice;
      ownedAnimals[animalKey]++;
      if(animalLastHarvest[animalKey] === 0) animalLastHarvest[animalKey] = Date.now();
      sounds.buy.play();
      showMessage(`${animals[animalKey].name} satƒ±n aldƒ±n.`);
      updateInfo();
      drawAnimals();
      renderMarketAnimals();
      saveGameAuto();
      const btns = marketAnimalsDiv.querySelectorAll('button');
      btns.forEach(btn => {
        if(btn.textContent.includes(animals[animalKey].name)) flashButton(btn);
      });
    } else {
      showMessage('Paran yetmiyor!');
    }
  }

  function flashButton(btn) {
    const originalBg = btn.style.backgroundColor;
    btn.style.backgroundColor = '#4caf50';
    setTimeout(() => {
      btn.style.backgroundColor = originalBg;
    }, 1000);
  }

  function updateSeedInventory() {
    seedListEl.innerHTML = '';
    for(const key in seeds) {
      const li = document.createElement('li');
      li.textContent = `${crops[key].name}: ${seeds[key]}`;
      seedListEl.appendChild(li);
    }
    for(const key in flowerSeeds) {
      const li = document.createElement('li');
      li.textContent = `${flowers[key].name}: ${flowerSeeds[key]}`;
      seedListEl.appendChild(li);
    }
  }

  function updateInfo() {
    let baseDay = localStorage.getItem("feyza_ciftligi_first_play_date");
    const today = getCurrentGameDay();
    if(!baseDay) {
      baseDay = today;
      localStorage.setItem("feyza_ciftligi_first_play_date", baseDay);
    }
    const baseDate = new Date(baseDay);
    const nowDate = new Date(today);
    const dayCount = Math.floor((nowDate - baseDate) / (1000*60*60*24)) + 1;

    const farmName = getFarmName() || "√áiftlik";
    infoEl.textContent = `G√ºn: ${dayCount} | Para: ${formatMoney(money)} | Versiyon: ${GAME_VERSION}`;
    farmTitle.textContent = `${farmName} üåæ`;
    document.title = `${farmName} üåæ`;
  }

  function formatMoney(m) {
    return m === Infinity ? '‚àû‚Ç∫' : `${m}‚Ç∫`;
  }

  function changePage(next) {
    if(next && currentFarmPage < farmPagesCount - 1) {
      currentFarmPage++;
    } else if(!next && currentFarmPage > 0) {
      currentFarmPage--;
    }
    selectedSeedKey = null;
    selectedSeedCategory = (currentFarmPage === 1) ? 'flowers' : 'crops';
    drawInventory();
    drawFarm();
  }

  function drawBugs() {
    bugFarmEl.innerHTML = '';
    if(currentFarmPage !== farmPagesCount -1) return;

    const bugKeys = Object.keys(purchasedBugs).filter(b => purchasedBugs[b]);
    if(bugKeys.length === 0) {
      bugFarmEl.textContent = 'B√∂cek satƒ±n alƒ±nmadƒ±.';
      bugFarmEl.style.fontSize = '16px';
      bugFarmEl.style.color = 'white';
      bugFarmEl.style.display = 'flex';
      bugFarmEl.style.alignItems = 'center';
      bugFarmEl.style.justifyContent = 'center';
      return;
    }

    bugFarmEl.style.fontSize = '';
    bugFarmEl.style.color = '';
    bugFarmEl.style.display = 'block';

    const cols = 5;
    const rows = Math.ceil(bugKeys.length / cols);
    const cellWidth = bugFarmEl.clientWidth / cols;
    const cellHeight = bugFarmEl.clientHeight / rows;

    bugKeys.forEach((bugKey, index) => {
      const bug = document.createElement('div');
      bug.className = 'bug';
      bug.textContent = bugs[bugKey].emoji;
      bug.title = bugs[bugKey].name;

      const col = index % cols;
      const row = Math.floor(index / cols);
      const x = col * cellWidth + (cellWidth - 30)/2;
      const y = row * cellHeight + (cellHeight - 30)/2;

      bug.style.left = `${x}px`;
      bug.style.top = `${y}px`;
      bug.style.transform = 'translate(0,0)';
      bug.dataset.bugKey = bugKey;

      bug.onclick = () => {
        showMessage(`Bu bir ${bugs[bugKey].name}!`);
      };

      bugFarmEl.appendChild(bug);
    });
  }

  function saveGameAuto() {
    try {
      const saveData = {
        version: GAME_VERSION,
        money: money === Infinity ? 'Infinity' : money,
        seeds,
        flowerSeeds,
        farms,
        currentFarmPage,
        purchasedBugs,
        purchasedEnhancers,
        ownedAnimals,
        animalHarvestReady,
        animalLastHarvest,
        selectedSeedCategory,
        selectedSeedKey,
        marketPrices,
        previousMarketPrices,
        marketLastUpdatedDay
      };
      localStorage.setItem('feyza_ciftligi_save_v2', JSON.stringify(saveData));
    } catch(e) {
      console.error('Otomatik kaydetme ba≈üarƒ±sƒ±z:', e);
    }
  }

  function loadGameAuto() {
    try {
      const data = localStorage.getItem('feyza_ciftligi_save_v2');
      if(!data) return false;
      const saveData = JSON.parse(data);

      if(saveData.money === 'Infinity' || saveData.money === Infinity) {
        money = 100;
      } else if(saveData.money !== undefined) {
        money = saveData.money;
      } else {
        money = 100;
      }

      seeds = saveData.seeds || { corn: 0, tomato: 0 };
      flowerSeeds = saveData.flowerSeeds || { rose: 0, tulip: 0, daisy: 0 };
      farms = saveData.farms || farms;
      currentFarmPage = saveData.currentFarmPage || 0;
      purchasedBugs = saveData.purchasedBugs || {};
      purchasedEnhancers = saveData.purchasedEnhancers || {};
      ownedAnimals = saveData.ownedAnimals || { chicken: 0, cow: 0, goat: 0 };
      animalHarvestReady = saveData.animalHarvestReady || { chicken: false, cow: false, goat: false };
      animalLastHarvest = saveData.animalLastHarvest || { chicken: 0, cow: 0, goat: 0 };
      selectedSeedCategory = saveData.selectedSeedCategory || 'crops';
      selectedSeedKey = saveData.selectedSeedKey || null;
      marketPrices = saveData.marketPrices || {};
      previousMarketPrices = saveData.previousMarketPrices || {};
      marketLastUpdatedDay = saveData.marketLastUpdatedDay || null;

      updateInfo();
      drawInventory();
      drawFarm();
      drawBugs();
      drawEnhancerList();
      drawAnimals();
      return true;
    } catch(e) {
      showMessage('Y√ºkleme ba≈üarƒ±sƒ±z!');
      console.error(e);
      return false;
    }
  }

  function showMessage(text) {
    messageEl.textContent = text;
    setTimeout(() => {
      if (messageEl.textContent === text) messageEl.textContent = '';
    }, 3000);
  }

  newGameBtn.addEventListener('click', () => {
    if(confirm('Yeni oyuna ba≈ülamak istediƒüine emin misin? T√ºm kayƒ±tlarƒ±n silinecek!')) {
      localStorage.removeItem('feyza_ciftligi_save_v2');
      localStorage.removeItem('feyza_ciftligi_farm_name');
      localStorage.removeItem("feyza_ciftligi_first_play_date");
      money = 100;
      seeds = { corn: 5, tomato: 5, carrot: 2, wheat: 1, pepper: 1 };
      flowerSeeds = { rose: 3, tulip: 3, daisy: 3, sunflower: 1, orchid: 1 };
      purchasedBugs = {};
      purchasedEnhancers = {};
      ownedAnimals = { chicken: 0, cow: 0, goat: 0 };
      animalHarvestReady = { chicken: false, cow: false, goat: false };
      animalLastHarvest = { chicken: 0, cow: 0, goat: 0 };
      farms = [];
      for(let i=0; i<farmPagesCount-1; i++) {
        let pageFarm = [];
        for(let j=0; j<farmSize*farmSize; j++) {
          pageFarm.push({
            state: 'empty',
            cropType: null,
            plantedAt: null,
            growTimeMinutes: 0
          });
        }
        farms.push(pageFarm);
      }
      farms.push([{ bugType: null, x: 0, y: 0 }]);
      currentFarmPage = 0;
      selectedSeedKey = null;
      selectedSeedCategory = 'crops';
      askFarmName(true);
      saveGameAuto();
      location.reload();
    }
  });

  prevPageBtn.addEventListener('click', () => changePage(false));
  nextPageBtn.addEventListener('click', () => changePage(true));

  openMarketBtn.addEventListener('click', () => {
    updateMarketPrices();
    openMarket();
  });
  closeMarketBtn.addEventListener('click', closeMarket);
  marketOverlay.addEventListener('click', () => {
    closeMarket();
    closeMarketPrices();
  });
  openMarketPricesBtn.addEventListener('click', openMarketPrices);
  closeMarketPricesBtn.addEventListener('click', closeMarketPrices);
  window.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') {
      closeMarket();
      closeMarketPrices();
    }
  });

  function getFarmName() {
    return localStorage.getItem('feyza_ciftligi_farm_name');
  }

  function askFarmName(forceAsk = false) {
    let name = getFarmName();
    if(name && !forceAsk) return name;
    name = prompt("Tarlanƒ±za bir isim verin! (√∂rneƒüin: Feyza'nƒ±n √áiftliƒüi)") || "Feyza'nƒ±n √áiftliƒüi";
    name = name.trim();
    if(name.length === 0) name = "Feyza'nƒ±n √áiftliƒüi";
    if(!name.endsWith('√áiftliƒüi')) name = `${name} √áiftliƒüi`;
    localStorage.setItem('feyza_ciftligi_farm_name', name);
    return name;
  }

  if(!getFarmName()) {
    askFarmName();
  }

  function periodicUpdate() {
    updateInfo();
    drawFarm();
    updateTimeInPlots();
    updateAnimalHarvestStatus();
    drawAnimals();
    updateMarketPrices();
    saveGameAuto();
    setTimeout(periodicUpdate, 1000);
  }

  const loaded = loadGameAuto();
  if(!loaded) saveGameAuto();
  periodicUpdate();

</script>

<script>
  if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker kayƒ±t edildi.'))
    .catch(err => console.log('Service Worker hatasƒ±:', err));
  }
</script>

</body>
</html>
